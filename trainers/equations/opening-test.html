<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –£—Ä–∞–≤–Ω–µ–Ω–∏–π: –ö–ª–∞—Å—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-paper: #f8fafc;
            --line-color: #cbd5e1;
            --primary: #4f46e5;   
            --accent: #0ea5e9;    
            --success: #16a34a;
            --danger: #dc2626;
            --text: #1e293b;
            --input-bg: #fff;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--bg-paper);
            background-image: 
                linear-gradient(var(--line-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--line-color) 1px, transparent 1px);
            background-size: 25px 25px;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: var(--text);
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* –ö–û–ù–¢–ï–ô–ù–ï–† */
        .quiz-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 700px;
            width: 100%;
            border: 2px solid #e2e8f0;
            position: relative;
            min-height: 350px;
        }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; padding-top: 40px;
        }
        .name-input {
            width: 80%; padding: 15px; font-size: 1.2rem;
            border: 2px solid var(--primary); border-radius: 10px;
            margin-bottom: 25px; outline: none; text-align: center;
            background: #eff6ff;
        }

        /* –≠–ö–†–ê–ù –ò–ì–†–´ */
        #game-interface { display: none; }

        .header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px;
        }
        .student-info { font-size: 0.9rem; color: #64748b; margin-top: 5px; font-weight: 600; }
        .score-box {
            background: var(--primary); color: white;
            padding: 5px 15px; border-radius: 20px; font-weight: bold;
        }

        /* –£–†–ê–í–ù–ï–ù–ò–Ø */
        .main-eq {
            font-size: 2rem; font-weight: 700; text-align: center;
            margin-bottom: 30px; letter-spacing: 1px;
            padding: 15px; background: #eff6ff; border-radius: 10px;
            border: 2px dashed var(--accent); color: var(--primary);
        }

        .step-row {
            display: flex; flex-direction: column; gap: 10px;
            margin-bottom: 20px; opacity: 0.5; pointer-events: none; filter: grayscale(100%);
            transition: all 0.3s ease;
        }
        .step-row.active { opacity: 1; pointer-events: all; filter: none; }
        .step-label { font-size: 0.9rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        
        .equation-line {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
            font-size: 1.5rem; font-weight: bold;
        }

        .math-input {
            width: 70px; padding: 5px; font-size: 1.3rem; text-align: center;
            border: 2px solid #cbd5e1; border-radius: 8px; outline: none;
            background: var(--input-bg); font-weight: bold;
        }
        .math-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); }
        .math-input.error { border-color: var(--danger); background: #fef2f2; animation: shake 0.4s; }
        .math-input.correct { border-color: var(--success); background: #dcfce7; pointer-events: none; }

        /* –ö–ù–û–ü–ö–ò */
        .btn-check {
            background: var(--success); color: white; border: none;
            padding: 8px 20px; border-radius: 8px; font-size: 1rem; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 0 #15803d;
        }
        .btn-check:active { transform: translateY(2px); box-shadow: 0 2px 0 #15803d; }
        
        .btn-start { background: var(--primary); width: 60%; font-size: 1.2rem; box-shadow: 0 4px 0 #3730a3; }

        /* –ö–ù–û–ü–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–°–∫—Ä—ã—Ç–∞—è/–°–µ–∫—Ä–µ—Ç–Ω–∞—è) */
        .btn-stats-secret {
            background: none; border: none; 
            color: white; /* –ù–µ–≤–∏–¥–∏–º–∞ –Ω–∞ –±–µ–ª–æ–º —Ñ–æ–Ω–µ */
            cursor: pointer; font-size: 0.8rem; margin-top: 30px;
            user-select: none;
        }
        .btn-stats-secret:hover { color: #f1f5f9; } /* –ß—É—Ç—å –≤–∏–¥–Ω–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */

        .btn-stats-visible {
            background: none; border: none; color: #94a3b8;
            cursor: pointer; font-size: 0.9rem; text-decoration: underline;
            margin-top: 20px;
        }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–¢–ê–¢–ò–°–¢–ò–ö–ò */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px;
            width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
        th { background: #f1f5f9; color: var(--primary); }
        tr:nth-child(even) { background: #f8fafc; }

        .btn-close-modal {
            background: var(--primary); color: white; border: none;
            padding: 8px 15px; border-radius: 5px; cursor: pointer; float: right;
        }

        .hidden { display: none; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .feedback-msg { text-align: center; font-weight: bold; margin-top: 10px; height: 20px; }
        .success-msg { color: var(--success); }
        .error-msg { color: var(--danger); }

    </style>
</head>
<body>

<div class="quiz-container">
    
    <div id="login-screen">
        <h2 style="margin-bottom: 30px; color: var(--text);">–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å</h2>
        <input type="text" id="inp-student-name" class="name-input" placeholder="–§–∞–º–∏–ª–∏—è –∏ –ò–º—è" autocomplete="off">
        <button class="btn-check btn-start" onclick="startTest()">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
        
        <div style="width: 100%; text-align: left; margin-top: 40px;">
            <button class="btn-stats-visible" onclick="showStatistics()">üìä –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</button>
        </div>
    </div>

    <div id="game-interface">
        <div class="header">
            <div>
                <h2 style="margin:0">üìù –ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞</h2>
                <div id="student-display" class="student-info">–£—á–µ–Ω–∏–∫: ...</div>
            </div>
            <div class="score-box">
                <span>–†–µ—à–µ–Ω–æ: <span id="score">0</span></span>
            </div>
        </div>

        <div id="main-equation" class="main-eq">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

        <div class="step-row active" id="step-1">
            <div class="step-label">–®–∞–≥ 1: –†–∞—Å–∫—Ä–æ–π —Å–∫–æ–±–∫–∏ —Å–ª–µ–≤–∞</div>
            <div class="equation-line">
                <input type="number" id="inp-s1-x" class="math-input" placeholder="?">
                <span>x</span>
                <span style="margin: 0 5px">+</span>
                <input type="number" id="inp-s1-num" class="math-input" placeholder="?">
                <span>=</span>
                <span id="static-right-part" style="color: #64748b">...</span>
                <button class="btn-check" onclick="checkStep1()">OK</button>
            </div>
            <div class="feedback-msg" id="msg-1"></div>
        </div>

        <div class="step-row" id="step-2">
            <div class="step-label">–®–∞–≥ 2: –ò–∫—Å—ã –≤–ª–µ–≤–æ, —á–∏—Å–ª–∞ –≤–ø—Ä–∞–≤–æ</div>
            <div class="equation-line">
                <input type="number" id="inp-s2-x" class="math-input" placeholder="?">
                <span>x</span>
                <span>=</span>
                <input type="number" id="inp-s2-num" class="math-input" placeholder="?">
                <button class="btn-check" onclick="checkStep2()">OK</button>
            </div>
            <div class="feedback-msg" id="msg-2"></div>
        </div>

        <div class="step-row" id="step-3">
            <div class="step-label">–®–∞–≥ 3: –ö–æ—Ä–µ–Ω—å</div>
            <div class="equation-line">
                <span>x = </span>
                <input type="number" id="inp-s3-res" class="math-input" placeholder="?">
                <button class="btn-check" onclick="checkStep3()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            </div>
            <div class="feedback-msg" id="msg-3"></div>
        </div>

        <button id="btn-next-level" class="btn-check hidden" style="width: 100%; margin-top: 20px; background: var(--primary); box-shadow: 0 4px 0 #3730a3;" onclick="nextLevel()">–°–ª–µ–¥—É—é—â–µ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ ‚û°</button>
        
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <button class="btn-stats-visible" style="color: var(--danger)" onclick="logout()">–ó–∞–≤–µ—Ä—à–∏—Ç—å (–í—ã—Ö–æ–¥)</button>
            <button class="btn-stats-secret" onclick="showStatistics()">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        </div>
    </div>
</div>

<div id="stats-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">–ñ—É—Ä–Ω–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
            <button class="btn-close-modal" onclick="closeStatistics()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <p style="color:#64748b; font-size:0.9rem;">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.</p>
        
        <div style="max-height: 300px; overflow-y: auto;">
            <table id="stats-table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–£—á–µ–Ω–∏–∫</th>
                        <th>–†–µ—à–µ–Ω–æ</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        </div>
</div>

<script>
    // --- DATABASE (Local Storage) ---
    const DB_KEY = 'math_quiz_class_results';
    
    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: Array of objects { id, name, score, timestamp }
    let currentStudentId = null;
    let score = 0;

    function getDB() {
        const raw = localStorage.getItem(DB_KEY);
        return raw ? JSON.parse(raw) : [];
    }

    function saveDB(data) {
        localStorage.setItem(DB_KEY, JSON.stringify(data));
    }

    function createSession(name) {
        const db = getDB();
        const newEntry = {
            id: Date.now(),
            name: name,
            score: 0,
            timestamp: new Date().toLocaleString()
        };
        db.push(newEntry);
        saveDB(db);
        currentStudentId = newEntry.id;
        score = 0;
        return newEntry;
    }

    function updateScoreInDB(newScore) {
        const db = getDB();
        const studentIdx = db.findIndex(item => item.id === currentStudentId);
        if (studentIdx !== -1) {
            db[studentIdx].score = newScore;
            saveDB(db);
        }
    }

    // --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê UI ---
    function showStatistics() {
        const db = getDB();
        const tbody = document.querySelector('#stats-table tbody');
        tbody.innerHTML = '';

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
        db.sort((a, b) => b.id - a.id).forEach(entry => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-size: 0.8rem">${entry.timestamp}</td>
                <td><strong>${entry.name}</strong></td>
                <td style="color: var(--success); font-weight:bold; font-size:1.1rem; text-align:center;">${entry.score}</td>
            `;
            tbody.appendChild(tr);
        });

        if (db.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
        }

        document.getElementById('stats-modal').style.display = 'flex';
    }

    function closeStatistics() {
        document.getElementById('stats-modal').style.display = 'none';
    }

    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∞, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å (F12)
    function clearStatistics() {
        if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –í–°–ï–• —É—á–µ–Ω–∏–∫–æ–≤ –∏–∑ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞.")) {
            localStorage.removeItem(DB_KEY);
            alert("–ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω.");
            location.reload();
        }
    }

    // --- –õ–û–ì–ò–ö–ê –í–•–û–î–ê ---
    function startTest() {
        const nameInp = document.getElementById('inp-student-name');
        const name = nameInp.value.trim();
        
        if (name.length < 2) {
            alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");
            return;
        }

        createSession(name);

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-interface').style.display = 'block';
        document.getElementById('student-display').innerText = "–£—á–µ–Ω–∏–∫: " + name;
        document.getElementById('score').innerText = "0";
        
        initLevel();
    }

    function logout() {
        if(confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É?")) {
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
        }
    }

    // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –£–†–ê–í–ù–ï–ù–ò–ô ---
    let currentData = {};

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function getRandomNonZero(min, max) {
        let val = 0;
        while (val === 0) val = getRandomInt(min, max);
        return val;
    }

    function generateEquation() {
        let ans = getRandomInt(-9, 9);
        if (ans === 0) ans = getRandomInt(1, 5);

        let mult = getRandomNonZero(-5, 5); 
        let brackNum = getRandomNonZero(-9, 9);
        
        let leftX = mult;
        let leftConst = mult * brackNum;

        let rightX = getRandomNonZero(-5, 5);
        while (rightX === leftX) { rightX = getRandomNonZero(-5, 5); }

        let rightConst = (leftX * ans) + leftConst - (rightX * ans);

        return {
            mult: mult, brackNum: brackNum, rightX: rightX, rightConst: rightConst,
            step1_x: leftX, step1_num: leftConst,
            step2_x: leftX - rightX, step2_num: rightConst - leftConst, 
            finalAns: ans
        };
    }

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–û–ú ---
    function initLevel() {
        currentData = generateEquation();
        
        let signB = currentData.brackNum >= 0 ? '+' : '‚àí';
        let valB = Math.abs(currentData.brackNum);
        
        let rightPartStr = "";
        if (currentData.rightX !== 0) rightPartStr += `${currentData.rightX}x`;
        let signR = currentData.rightConst >= 0 ? '+' : '‚àí';
        
        if (currentData.rightX !== 0) rightPartStr += ` ${signR} ${Math.abs(currentData.rightConst)}`;
        else rightPartStr += `${currentData.rightConst}`;

        const eqHTML = `${currentData.mult}(x ${signB} ${valB}) = ${rightPartStr}`;
        document.getElementById('main-equation').innerHTML = eqHTML;
        document.getElementById('static-right-part').innerText = rightPartStr;

        resetInputs();
        setStep(1);
    }

    function resetInputs() {
        document.querySelectorAll('.math-input').forEach(i => {
            i.value = ''; i.classList.remove('error', 'correct'); i.disabled = false;
        });
        document.querySelectorAll('.feedback-msg').forEach(m => { m.innerText = ''; m.className = 'feedback-msg'; });
        document.querySelectorAll('.btn-check').forEach(b => b.classList.remove('hidden'));
        document.getElementById('btn-next-level').classList.add('hidden');
    }

    function setStep(num) {
        document.querySelectorAll('.step-row').forEach(row => row.classList.remove('active'));
        const activeRow = document.getElementById(`step-${num}`);
        if(activeRow) activeRow.classList.add('active');
        setTimeout(() => {
            const firstInput = activeRow.querySelector('.math-input');
            if(firstInput) firstInput.focus();
        }, 100);
    }

    // --- –ü–†–û–í–ï–†–ö–ò ---
    function validateInput(id, expectedVal) {
        const input = document.getElementById(id);
        const val = parseInt(input.value.replace(/\s/g, ''));
        if (isNaN(val)) return false;
        if (val === expectedVal) {
            input.classList.add('correct'); input.classList.remove('error'); return true;
        } else {
            input.classList.add('error'); setTimeout(() => input.classList.remove('error'), 500); return false;
        }
    }

    function checkStep1() {
        if (validateInput('inp-s1-x', currentData.step1_x) && validateInput('inp-s1-num', currentData.step1_num)) {
            msgSuccess('msg-1', "–í–µ—Ä–Ω–æ!");
            document.querySelector('#step-1 .btn-check').classList.add('hidden');
            setStep(2);
        } else { msgError('msg-1', "–û—à–∏–±–∫–∞ –≤ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏ —Å–∫–æ–±–æ–∫"); }
    }

    function checkStep2() {
        if (validateInput('inp-s2-x', currentData.step2_x) && validateInput('inp-s2-num', currentData.step2_num)) {
            msgSuccess('msg-2', "–í–µ—Ä–Ω–æ!");
            document.querySelector('#step-2 .btn-check').classList.add('hidden');
            setStep(3);
        } else { msgError('msg-2', "–û—à–∏–±–∫–∞ –≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö"); }
    }

    function checkStep3() {
        if (validateInput('inp-s3-res', currentData.finalAns)) {
            msgSuccess('msg-3', "–ü–†–ê–í–ò–õ–¨–ù–û!");
            document.querySelector('#step-3 .btn-check').classList.add('hidden');
            document.getElementById('btn-next-level').classList.remove('hidden');
            
            score++;
            document.getElementById('score').innerText = score;
            document.getElementById('score').style.animation = "shake 0.5s";
            
            // –û–ë–ù–û–í–õ–Ø–ï–ú –ë–ê–ó–£
            updateScoreInDB(score);
        } else { msgError('msg-3', "–û—à–∏–±–∫–∞"); }
    }

    function msgSuccess(id, text) {
        const m = document.getElementById(id); m.innerText = text; m.classList.add('success-msg');
    }
    function msgError(id, text) {
        const m = document.getElementById(id); m.innerText = text; m.classList.add('error-msg');
    }

    function nextLevel() { initLevel(); }

    // Keypresses
    document.getElementById('inp-student-name').addEventListener('keypress', e => { if (e.key === 'Enter') startTest(); });
    document.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            const activeStep = document.querySelector('.step-row.active');
            if (activeStep) {
                const btn = activeStep.querySelector('.btn-check');
                if (btn && !btn.classList.contains('hidden')) btn.click();
                else if (!document.getElementById('btn-next-level').classList.contains('hidden')) nextLevel();
            }
        }
    });

</script>
</body>
</html>