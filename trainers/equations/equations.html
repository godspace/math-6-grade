<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ü—É—Ç—å: 20 –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –®–∞–≥–æ–≤</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --accent: #fdcb6e;
            --success: #00b894;
            --error: #ff7675;
            --bg: #dfe6e9;
        }

        body {
            font-family: 'Segoe UI', 'Comic Sans MS', sans-serif;
            background-color: var(--bg);
            background-image: radial-gradient(#b2bec3 10%, transparent 11%);
            background-size: 20px 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            user-select: none;
        }

        .header {
            width: 100%;
            max-width: 850px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .level-badge {
            background: var(--primary);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.4);
        }

        .difficulty-label {
            font-weight: bold;
            color: #636e72;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .progress-bg {
            width: 100%;
            height: 16px;
            background-color: #b2bec3;
            border-radius: 10px;
            overflow: hidden;
            border: 3px solid white;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--secondary), var(--success));
            transition: width 0.6s ease-out;
        }

        .game-board {
            width: 100%;
            max-width: 850px;
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .task-card {
            background: #f1f2f6;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            font-size: 1.2rem;
            line-height: 1.6;
            color: #2d3436;
            border-left: 8px solid var(--accent);
        }

        .drop-zone-container { margin-bottom: 25px; }

        .label {
            font-weight: bold;
            color: #636e72;
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1.2px;
        }

        .equation-builder {
            min-height: 110px;
            background-color: #f8f9fa;
            border: 3px dashed #b2bec3;
            border-radius: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .equation-builder.drag-over {
            background-color: #e3f2fd;
            border-color: var(--primary);
            transform: scale(1.01);
        }

        .solve-area {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #dfe6e9;
            border-radius: 15px;
            flex-wrap: wrap;
        }

        .solve-input {
            width: 120px;
            padding: 10px;
            font-size: 1.4rem;
            border: 3px solid #b2bec3;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
            outline: none;
        }
        .solve-input:focus { border-color: var(--secondary); background: white; }

        .card-dock {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f1f2f6;
        }

        .card-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border: 2px solid #dfe6e9;
            border-bottom-width: 5px;
            color: #2d3436;
            padding: 8px 18px;
            border-radius: 12px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: grab;
            transition: all 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 30px;
        }

        .card:active {
            cursor: grabbing;
            transform: translateY(3px);
            border-bottom-width: 2px;
        }

        .card.variable { background: #a29bfe; color: white; border-color: #6c5ce7; }
        .card.operator { background: #ffeaa7; color: #d35400; border-color: #fdcb6e; }
        .card.number { color: var(--primary); border-color: var(--primary); }

        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-check { background: linear-gradient(45deg, var(--success), #00cec9); }
        .btn-reset { background: #b2bec3; }

        .feedback-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.96);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            border-radius: 25px;
            text-align: center;
            padding: 20px;
        }
        
        .feedback-overlay.visible { opacity: 1; pointer-events: all; }
        .success-title { font-size: 2.5rem; color: var(--success); margin-bottom: 10px; }
        .next-btn { 
            background: var(--primary); 
            padding: 15px 50px; 
            color: white; 
            border: none; 
            border-radius: 50px; 
            font-size: 1.5rem; 
            cursor: pointer; 
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.4);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake { animation: shake 0.4s; }

        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 999; }
    </style>
<script src="../../assets/analytics.js"></script>
</head>
<body>

    <div class="header">
        <div class="level-info">
            <div class="level-badge" id="levelIndicator">–£—Ä–æ–≤–µ–Ω—å 1</div>
            <div class="difficulty-label" id="difficultyLabel">–ù–∞—á–∞–ª–æ</div>
        </div>
        <div class="progress-bg">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <div class="game-board" id="gameBoard">
        <div class="task-card" id="problemText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

        <div class="drop-zone-container">
            <span class="label">1. –°–æ—Å—Ç–∞–≤—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ (–ø–µ—Ä–µ—Ç–∞—â–∏ –∫–∞—Ä—Ç–æ—á–∫–∏):</span>
            <div class="equation-builder" id="dropZone"></div>
        </div>

        <div class="solve-area">
            <span class="label" style="margin:0; font-size: 1rem; margin-right: 15px;">2. –ß–µ–º—É —Ä–∞–≤–µ–Ω x?</span>
            <span style="font-size: 1.5rem; font-weight: bold; color: #2d3436;">x = </span>
            <input type="number" class="solve-input" id="solutionInput" placeholder="?" step="0.1">
        </div>

        <div class="card-dock">
            <span class="label">–ß–∏—Å–ª–∞ –∏–∑ –∑–∞–¥–∞—á–∏:</span>
            <div class="card-group" id="problemCards"></div>
            
            <span class="label">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</span>
            <div class="card-group">
                <div class="card operator" draggable="true" data-val="+">+</div>
                <div class="card operator" draggable="true" data-val="-">-</div>
                <div class="card operator" draggable="true" data-val="*">*</div>
                <div class="card operator" draggable="true" data-val="/">/</div>
                <div class="card operator" draggable="true" data-val="=">=</div>
                <div class="card operator" draggable="true" data-val="(">(</div>
                <div class="card operator" draggable="true" data-val=")">)</div>
                <div class="card variable" draggable="true" data-val="x">x</div>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-reset" onclick="resetCurrentLevel()">–°–±—Ä–æ—Å</button>
            <button class="btn btn-check" onclick="checkSolution()">–ü–†–û–í–ï–†–ò–¢–¨</button>
        </div>

        <div class="feedback-overlay" id="feedbackOverlay">
            <div class="success-title">–í–µ—Ä–Ω–æ!</div>
            <div style="font-size: 1.2rem; margin-bottom: 20px; color: #636e72;" id="praiseText">–¢—ã –º–æ–ª–æ–¥–µ—Ü</div>
            <button class="next-btn" id="nextLevelBtn" onclick="nextLevel()">–î–∞–ª—å—à–µ ‚ûú</button>
        </div>
    </div>
    
    <canvas id="confettiCanvas"></canvas>

<script>
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // --- –õ–ò–ù–ï–ô–ù–´–ô –°–ü–ò–°–û–ö –£–†–û–í–ù–ï–ô (–ö–∞–∂–¥—ã–π —Ç–∏–ø –∑–∞–¥–∞—á–∏ —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑) ---
    // –í—Å–µ–≥–æ 20 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ –Ω–∞—Ä–∞—Å—Ç–∞—é—â–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    
    const LEVEL_SCENARIOS = [
        /* === –†–ê–ó–î–ï–õ 1: –†–ê–ó–ú–ò–ù–ö–ê (4 –∑–∞–¥–∞—á–∏) === */
        {
            type: "warmup", label: "–†–∞–∑–º–∏–Ω–∫–∞ (1 –¥–µ–π—Å—Ç–≤–∏–µ)", color: "#00b894",
            gen: () => { // 1. –°–ª–æ–∂–µ–Ω–∏–µ (x + a = b)
                const x = getRandomInt(10, 50); const a = getRandomInt(10, 30);
                return { text: `–ó–∞–¥—É–º–∞–ª–∏ —á–∏—Å–ª–æ, –ø—Ä–∏–±–∞–≤–∏–ª–∏ ${a} –∏ –ø–æ–ª—É—á–∏–ª–∏ ${x+a}. –ö–∞–∫–æ–µ —á–∏—Å–ª–æ –∑–∞–¥—É–º–∞–ª–∏?`, solveX: x };
            }
        },
        {
            type: "warmup", label: "–†–∞–∑–º–∏–Ω–∫–∞ (1 –¥–µ–π—Å—Ç–≤–∏–µ)", color: "#00b894",
            gen: () => { // 2. –í—ã—á–∏—Ç–∞–Ω–∏–µ (x - a = b)
                const a = getRandomInt(10, 20); const b = getRandomInt(15, 30);
                return { text: `–ò–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —á–∏—Å–ª–∞ –≤—ã—á–ª–∏ ${a} –∏ –ø–æ–ª—É—á–∏–ª–∏ ${b}. –ù–∞–π–¥–∏ —ç—Ç–æ —á–∏—Å–ª–æ.`, solveX: a+b };
            }
        },
        {
            type: "warmup", label: "–†–∞–∑–º–∏–Ω–∫–∞ (1 –¥–µ–π—Å—Ç–≤–∏–µ)", color: "#00b894",
            gen: () => { // 3. –ü–ª–æ—â–∞–¥—å (a * x = S)
                const x = getRandomInt(5, 12); const a = getRandomInt(4, 9);
                return { text: `–ü–ª–æ—â–∞–¥—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ ${x*a} —Å–º¬≤, –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ ${a} —Å–º. –ù–∞–π–¥–∏ –¥—Ä—É–≥—É—é (x).`, solveX: x };
            }
        },
        {
            type: "warmup", label: "–†–∞–∑–º–∏–Ω–∫–∞ (1 –¥–µ–π—Å—Ç–≤–∏–µ)", color: "#00b894",
            gen: () => { // 4. –î–µ–ª–µ–Ω–∏–µ (x / a = b)
                const a = getRandomInt(3, 8); const b = getRandomInt(5, 12);
                return { text: `–ß–∏—Å–ª–æ x —É–º–µ–Ω—å—à–∏–ª–∏ –≤ ${a} —Ä–∞–∑ –∏ –ø–æ–ª—É—á–∏–ª–∏ ${b}. –ß–µ–º—É —Ä–∞–≤–µ–Ω x?`, solveX: a*b };
            }
        },

        /* === –†–ê–ó–î–ï–õ 2: –ë–ê–ó–ê (4 –∑–∞–¥–∞—á–∏) === */
        {
            type: "grade3", label: "–û—Å–Ω–æ–≤—ã –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è", color: "#fdcb6e",
            gen: () => { // 5. –ü–µ—Ä–∏–º–µ—Ç—Ä —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ (2x + b = P)
                const x = getRandomInt(10, 20); const b = getRandomInt(5, 15);
                return { text: `–ü–µ—Ä–∏–º–µ—Ç—Ä —Ä–∞–≤–Ω–æ–±–µ–¥—Ä–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ ${2*x+b} —Å–º, –æ—Å–Ω–æ–≤–∞–Ω–∏–µ ${b} —Å–º. –ù–∞–π–¥–∏ –±–æ–∫–æ–≤—É—é —Å—Ç–æ—Ä–æ–Ω—É (x).`, solveX: x };
            }
        },
        {
            type: "grade3", label: "–û—Å–Ω–æ–≤—ã –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è", color: "#fdcb6e",
            gen: () => { // 6. –ú–∞–≥–∞–∑–∏–Ω –∏ —Å–¥–∞—á–∞ (Money - n*p = Change) => x - cost = change
                const price = getRandomInt(20, 40); const count = 3; const total = price * count;
                const money = total + getRandomInt(10, 50);
                return { text: `–î–∞—à–∞ –∫—É–ø–∏–ª–∞ ${count} —Ä—É—á–∫–∏ –ø–æ ${price} —Ä. –°–¥–∞—á–∞ —Å–æ—Å—Ç–∞–≤–∏–ª–∞ ${money - total} —Ä. –°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ (x) –±—ã–ª–æ —É –î–∞—à–∏?`, solveX: money };
            }
        },
        {
            type: "grade3", label: "–û—Å–Ω–æ–≤—ã –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è", color: "#fdcb6e",
            gen: () => { // 7. –õ–∏–Ω–µ–π–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (ax + b = c)
                const x = getRandomInt(5, 15); const a = getRandomInt(3, 6); const b = getRandomInt(10, 30);
                return { text: `–Ø –∑–∞–¥—É–º–∞–ª —á–∏—Å–ª–æ, —É–º–Ω–æ–∂–∏–ª –µ–≥–æ –Ω–∞ ${a}, –ø—Ä–∏–±–∞–≤–∏–ª ${b} –∏ –ø–æ–ª—É—á–∏–ª ${x*a+b}. –ö–∞–∫–æ–µ —á–∏—Å–ª–æ —è –∑–∞–¥—É–º–∞–ª?`, solveX: x };
            }
        },
        {
            type: "grade3", label: "–û—Å–Ω–æ–≤—ã –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è", color: "#fdcb6e",
            gen: () => { // 8. –°—É–º–º–∞ —á–∞—Å—Ç–µ–π (x + 4x = S)
                const x = getRandomInt(5, 12); 
                return { text: `–í –ø–µ—Ä–≤–æ–º —è—â–∏–∫–µ —è–±–ª–æ–∫ –≤ 4 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ, —á–µ–º –≤–æ –≤—Ç–æ—Ä–æ–º (x). –í—Å–µ–≥–æ –≤ –¥–≤—É—Ö —è—â–∏–∫–∞—Ö ${x + 4*x} –∫–≥. –°–∫–æ–ª—å–∫–æ –≤–æ –≤—Ç–æ—Ä–æ–º?`, solveX: x };
            }
        },

        /* === –†–ê–ó–î–ï–õ 3: –î–í–ò–ñ–ï–ù–ò–ï –ò –ò–ó–ú–ï–ù–ï–ù–ò–Ø (4 –∑–∞–¥–∞—á–∏) === */
        {
            type: "grade4", label: "–î–≤–∏–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã", color: "#0984e3",
            gen: () => { // 9. –í—Å—Ç—Ä–µ—á–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ (v1+v2)*t = S
                const v1 = 60; const v2 = 80; const t = getRandomInt(2, 5);
                return { text: `–ú–∞—à–∏–Ω—ã –≤—ã–µ—Ö–∞–ª–∏ –Ω–∞–≤—Å—Ç—Ä–µ—á—É (60 –∫–º/—á –∏ 80 –∫–º/—á). –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ ${(v1+v2)*t} –∫–º. –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ (x) –æ–Ω–∏ –≤—Å—Ç—Ä–µ—Ç—è—Ç—Å—è?`, solveX: t };
            }
        },
        {
            type: "grade4", label: "–î–≤–∏–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã", color: "#0984e3",
            gen: () => { // 10. –î–≤–∏–∂–µ–Ω–∏–µ –ø–æ —Ä–µ–∫–µ (v_lod + x)*t = S
                const vBoat = 15; const vRiver = getRandomInt(2, 4); const t = 3;
                return { text: `–ö–∞—Ç–µ—Ä –ø–ª—ã–ª –ø–æ —Ç–µ—á–µ–Ω–∏—é ${t} —á. –°–∫–æ—Ä–æ—Å—Ç—å –∫–∞—Ç–µ—Ä–∞ ${vBoat} –∫–º/—á, –ø—É—Ç—å ${(vBoat+vRiver)*t} –∫–º. –ù–∞–π–¥–∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Ç–µ—á–µ–Ω–∏—è (x).`, solveX: vRiver };
            }
        },
        {
            type: "grade4", label: "–î–≤–∏–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã", color: "#0984e3",
            gen: () => { // 11. –ë—ã–ª–æ/–°—Ç–∞–ª–æ (x - a + b = c)
                const init = getRandomInt(50, 90); const sold = 20; const add = 15;
                return { text: `–ù–∞ —Å–∫–ª–∞–¥–µ –±—ã–ª–æ x —Ç–æ–Ω–Ω. –£–≤–µ–∑–ª–∏ ${sold}, –ø—Ä–∏–≤–µ–∑–ª–∏ ${add}. –°—Ç–∞–ª–æ ${init - sold + add}. –°–∫–æ–ª—å–∫–æ –±—ã–ª–æ?`, solveX: init };
            }
        },
        {
            type: "grade4", label: "–î–≤–∏–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã", color: "#0984e3",
            gen: () => { // 12. –†–∞–∑–Ω–æ—Å—Ç—å –∫—Ä–∞—Ç–Ω—ã—Ö (5x - x = Diff)
                const x = getRandomInt(10, 20);
                return { text: `–ü–∞–ø–∞ —Ç—è–∂–µ–ª–µ–µ —Å—ã–Ω–∞ (x) –≤ 5 —Ä–∞–∑. –†–∞–∑–Ω–∏—Ü–∞ –≤ –≤–µ—Å–µ ${5*x - x} –∫–≥. –°–∫–æ–ª—å–∫–æ –≤–µ—Å–∏—Ç —Å—ã–Ω?`, solveX: x };
            }
        },

        /* === –†–ê–ó–î–ï–õ 4: –°–õ–û–ñ–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê (4 –∑–∞–¥–∞—á–∏) === */
        {
            type: "grade5", label: "–°–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏", color: "#d63031",
            gen: () => { // 13. –°–∫–æ–±–∫–∏ –∫–∞–∫ –º–Ω–æ–∂–∏—Ç–µ–ª—å (x+a)*m = c
                const x = getRandomInt(5, 15); const a = 10; const m = 4;
                return { text: `–ó–∞–¥—É–º–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ —É–≤–µ–ª–∏—á–∏–ª–∏ –Ω–∞ ${a}, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–º–Ω–æ–∂–∏–ª–∏ –Ω–∞ ${m} –∏ –ø–æ–ª—É—á–∏–ª–∏ ${(x+a)*m}. –ù–∞–π—Ç–∏ —á–∏—Å–ª–æ.`, solveX: x };
            }
        },
        {
            type: "grade5", label: "–°–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏", color: "#d63031",
            gen: () => { // 14. –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¥–µ–ª–∏—Ç–µ–ª—å A / (B - x) = C
                const x = getRandomInt(2, 8); const b = x + 5; const c = 4;
                return { text: `–ï—Å–ª–∏ 100 —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ —Ä–∞–∑–Ω–æ—Å—Ç—å (${b} - x), —Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è ${(100/(b-x)).toFixed(0)}. –ß–µ–º—É —Ä–∞–≤–µ–Ω x? (–û—Ç–≤–µ—Ç —Ü–µ–ª—ã–π)`, solveX: x };
            }
        },
        {
            type: "grade5", label: "–°–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏", color: "#d63031",
            gen: () => { // 15. –ü–µ—Ä–∏–º–µ—Ç—Ä –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ 2(a+x)=P
                const a = getRandomInt(10, 20); const b = getRandomInt(10, 20);
                return { text: `–ü–µ—Ä–∏–º–µ—Ç—Ä —É—á–∞—Å—Ç–∫–∞ ${2*(a+b)} –º, —à–∏—Ä–∏–Ω–∞ ${a} –º. –ù–∞–π–¥–∏ –¥–ª–∏–Ω—É (x).`, solveX: b };
            }
        },
        {
            type: "grade5", label: "–°–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏", color: "#d63031",
            gen: () => { // 16. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω 3(x+2) = val
                const x = 10; const val = 3*(x+2);
                return { text: `–†–µ—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: 3 * (x + 2) = ${val}`, solveX: x };
            }
        },

        /* === –†–ê–ó–î–ï–õ 5: –ü–†–û–§–ò (4 –∑–∞–¥–∞—á–∏) === */
        {
            type: "profi", label: "–ü—Ä–æ—Ñ–∏ (6 –∫–ª–∞—Å—Å)", color: "#6c5ce7",
            gen: () => { // 17. –í–µ—Å—ã (–ø–µ—Ä–µ–Ω–æ—Å) 3x - 10 = x + 10
                const x = 10; const diff = 5; // 3x - 5 = x + 15 (–ø—Ä–∏ x=10 -> 25=25)
                return { text: `–ù–∞ –ø–µ—Ä–≤–æ–π –ø–æ–ª–∫–µ –∫–Ω–∏–≥ –≤ 3 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ (3*x). –ï—Å–ª–∏ —Å –Ω–µ—ë —É–±—Ä–∞—Ç—å ${diff}, –∞ –Ω–∞ –≤—Ç–æ—Ä—É—é (x) –¥–æ–±–∞–≤–∏—Ç—å 15, —Å—Ç–∞–Ω–µ—Ç –ø–æ—Ä–æ–≤–Ω—É. –ù–∞–π–¥–∏ x.`, solveX: x };
            }
        },
        {
            type: "profi", label: "–ü—Ä–æ—Ñ–∏ (6 –∫–ª–∞—Å—Å)", color: "#6c5ce7",
            gen: () => { // 18. –î–µ—Å—è—Ç–∏—á–Ω—ã–µ –¥—Ä–æ–±–∏ 0.5x = 10
                const x = 20;
                return { text: `–ü–æ–ª–æ–≤–∏–Ω–∞ —á–∏—Å–ª–∞ (0.5 * x) —Ä–∞–≤–Ω–∞ 10. –ß–µ–º—É —Ä–∞–≤–Ω–æ —Å–∞–º–æ —á–∏—Å–ª–æ?`, solveX: x };
            }
        },
        {
            type: "profi", label: "–ü—Ä–æ—Ñ–∏ (6 –∫–ª–∞—Å—Å)", color: "#6c5ce7",
            gen: () => { // 19. –ü—Ä–æ—Ü–µ–Ω—Ç—ã (–ø–æ–≤—ã—à–µ–Ω–∏–µ) x + 0.2x = 1.2x
                const x = 100;
                return { text: `–¢–æ–≤–∞—Ä —Å—Ç–æ–∏–ª x. –ü–æ–¥–æ—Ä–æ–∂–∞–ª –Ω–∞ 20% (—Å—Ç–∞–ª 1.2 * x) –∏ —Ç–µ–ø–µ—Ä—å —Å—Ç–æ–∏—Ç 120. –ù–∞–π–¥–∏ —Å—Ç–∞—Ä—É—é —Ü–µ–Ω—É.`, solveX: x };
            }
        },
        {
            type: "profi", label: "–ü—Ä–æ—Ñ–∏ (6 –∫–ª–∞—Å—Å)", color: "#6c5ce7",
            gen: () => { // 20. –£—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥–≤—É—Ö —Å—Ç–æ—Ä–æ–Ω 5x - 20 = 3x
                const x = 10; // 50 - 20 = 30
                return { text: `–†–µ—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: 5 * x - 20 = 3 * x`, solveX: x };
            }
        }
    ];

    // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
    let currentLevel = 0;
    let currentProblemData = null;
    let isLevelSolved = false;
    let draggedElement = null;
    let draggedData = null;

    document.addEventListener('DOMContentLoaded', () => {
        setupDragAndDrop();
        initLevel(0);
    });

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'success') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.setValueAtTime(659.25, now+0.1); osc.frequency.setValueAtTime(783.99, now+0.2); 
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.4);
            osc.start(now); osc.stop(now+0.4);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.2);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        }
    }

    function initLevel(levelIndex) {
        currentLevel = levelIndex;
        isLevelSolved = false;

        if (currentLevel >= LEVEL_SCENARIOS.length) {
            gameComplete();
            return;
        }
        
        const scenario = LEVEL_SCENARIOS[currentLevel];
        
        // UI –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        const badge = document.getElementById('levelIndicator');
        badge.textContent = `–£—Ä–æ–≤–µ–Ω—å ${currentLevel + 1} –∏–∑ ${LEVEL_SCENARIOS.length}`;
        badge.style.background = scenario.color;
        
        const label = document.getElementById('difficultyLabel');
        label.textContent = scenario.label;
        label.style.color = scenario.color;

        const progressPct = (currentLevel / LEVEL_SCENARIOS.length) * 100;
        document.getElementById('progressBar').style.width = `${progressPct}%`;
        
        resetCurrentLevel();

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á–∏
        currentProblemData = scenario.gen();

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        document.getElementById('problemText').innerHTML = currentProblemData.text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

        // –ö–∞—Ä—Ç–æ—á–∫–∏
        const cardsContainer = document.getElementById('problemCards');
        cardsContainer.innerHTML = '';
        const numbers = currentProblemData.text.match(/\d+([.,]\d+)?/g);
        if (numbers) {
            numbers.forEach(numStr => {
                let val = numStr.replace(',', '.'); 
                createCard(val, 'number', cardsContainer);
            });
        }
    }

    function resetCurrentLevel() {
        document.getElementById('dropZone').innerHTML = '';
        document.getElementById('solutionInput').value = '';
        document.getElementById('solutionInput').style.backgroundColor = 'white';
        document.getElementById('feedbackOverlay').classList.remove('visible');
        isLevelSolved = false;
    }

    function createCard(text, type, container) {
        const el = document.createElement('div');
        el.className = `card ${type}`;
        el.draggable = true;
        el.textContent = text;
        el.dataset.val = text;
        container.appendChild(el);
    }

    function checkSolution() {
        const dropZone = document.getElementById('dropZone');
        const inputVal = document.getElementById('solutionInput').value;
        const gameBoard = document.getElementById('gameBoard');

        const triggerShake = () => {
            playSound('error');
            gameBoard.classList.remove('shake');
            void gameBoard.offsetWidth;
            gameBoard.classList.add('shake');
        };

        if (inputVal === '') { alert("–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç –¥–ª—è x!"); triggerShake(); return; }

        const cards = Array.from(dropZone.children);
        const equationParts = cards.map(c => c.dataset.val);

        if (equationParts.length < 3 || !equationParts.includes('=')) {
            alert("–£—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–µ –∑–∞–∫–æ–Ω—á–µ–Ω–æ! –ü–µ—Ä–µ—Ç–∞—â–∏ —á–∏—Å–ª–∞ –∏ –∑–Ω–∞–∫–∏."); triggerShake(); return;
        }

        const sides = equationParts.join('').split('=');
        if (sides.length !== 2) { triggerShake(); return; }

        const correctX = currentProblemData.solveX;
        let equationCorrect = false;

        try {
            const leftExp = sides[0].replace(/x/g, `(${correctX})`);
            const rightExp = sides[1].replace(/x/g, `(${correctX})`);
            
            const valLeft = new Function(`return ${leftExp}`)();
            const valRight = new Function(`return ${rightExp}`)();

            if (Math.abs(valLeft - valRight) < 0.01) {
                if (!equationParts.includes('x')) {
                    alert("–ì–¥–µ –∂–µ x –≤ —Ç–≤–æ–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–∏?"); triggerShake(); return;
                }
                equationCorrect = true;
            }
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ –≤ –∑–∞–ø–∏—Å–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è."); triggerShake(); return;
        }

        const userX = parseFloat(inputVal.replace(',', '.'));
        
        if (equationCorrect && Math.abs(userX - correctX) < 0.1) {
            levelPassed();
        } else if (equationCorrect) {
            alert("–£—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä–Ω–æ–µ, –Ω–æ x –ø–æ—Å—á–∏—Ç–∞–Ω —Å –æ—à–∏–±–∫–æ–π.");
            document.getElementById('solutionInput').style.backgroundColor = '#fab1a0';
            triggerShake();
        } else {
            alert("–£—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–µ —Å—Ö–æ–¥–∏—Ç—Å—è.");
            triggerShake();
        }
    }

    function levelPassed() {
        playSound('success');
        isLevelSolved = true;
        const praises = ["–ú–æ–ª–æ–¥–µ—Ü!", "–í–µ—Ä–Ω–æ!", "–û—Ç–ª–∏—á–Ω–æ!", "–°—É–ø–µ—Ä!"];
        document.getElementById('praiseText').textContent = praises[Math.floor(Math.random() * praises.length)];
        document.getElementById('feedbackOverlay').classList.add('visible');
        startConfetti();
    }

    function nextLevel() {
        if (!isLevelSolved) return; 
        stopConfetti();
        initLevel(currentLevel + 1);
    }

    function gameComplete() {
        document.getElementById('gameBoard').innerHTML = `
            <div style="text-align:center; padding: 40px;">
                <h1 style="color:var(--success); font-size:3rem;">üèÜ –ö–£–†–° –ü–†–û–ô–î–ï–ù!</h1>
                <p style="font-size:1.5rem;">–¢—ã —Ä–µ—à–∏–ª –≤—Å–µ 20 —Ç–∏–ø–æ–≤ –∑–∞–¥–∞—á.</p>
                <button class="btn btn-check" onclick="location.reload()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
            </div>
        `;
        startConfetti();
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('levelIndicator').textContent = "–§–ò–ù–ò–®";
    }

    function setupDragAndDrop() {
        document.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('card')) {
                draggedElement = e.target;
                draggedData = {
                    val: e.target.dataset.val,
                    type: e.target.classList.contains('operator') ? 'operator' : 
                          e.target.classList.contains('variable') ? 'variable' : 'number',
                    isClone: e.target.closest('.equation-builder') !== null
                };
                e.dataTransfer.effectAllowed = 'copyMove';
                setTimeout(() => e.target.style.opacity = '0.5', 0);
            }
        });
        document.addEventListener('dragend', (e) => {
            if (e.target.classList.contains('card')) { e.target.style.opacity = '1'; draggedElement = null; }
        });
        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.classList.remove('drag-over');
            if (!draggedData) return;
            if (draggedData.isClone) {
                dropZone.appendChild(draggedElement);
            } else {
                const newCard = document.createElement('div');
                newCard.className = `card ${draggedData.type}`;
                newCard.textContent = draggedData.val;
                newCard.dataset.val = draggedData.val;
                newCard.draggable = true;
                newCard.onclick = function() { this.remove(); };
                dropZone.appendChild(newCard);
            }
        });
    }

    const canvas = document.getElementById("confettiCanvas");
    const ctx = canvas.getContext("2d");
    let confettiActive = false;
    let particles = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    function startConfetti() {
        if (confettiActive) return;
        confettiActive = true;
        particles = [];
        for (let i = 0; i < 150; i++) particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height - canvas.height, color: `hsl(${Math.random()*360},100%,50%)`, size: Math.random()*10+5, speedY: Math.random()*3+3, speedX: Math.random()*2-1 });
        animateConfetti();
    }
    function stopConfetti() { confettiActive = false; particles = []; ctx.clearRect(0, 0, canvas.width, canvas.height); }
    function animateConfetti() {
        if (!confettiActive) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p, i) => {
            p.y += p.speedY; p.x += p.speedX;
            ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
            if (p.y > canvas.height) particles[i].y = -10;
        });
        requestAnimationFrame(animateConfetti);
    }
</script>
</body>

</html>
