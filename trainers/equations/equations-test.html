<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Ç–æ–≥–æ–≤–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞: –£—Ä–∞–≤–Ω–µ–Ω–∏—è</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --error: #c0392b;
            --light: #ecf0f1;
            --dark: #34495e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--primary);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* --- –≠–ö–†–ê–ù–´ --- */
        .screen { display: none; width: 100%; max-width: 950px; padding: 20px; box-sizing: border-box; }
        .screen.active { display: block; }

        /* --- –õ–û–ì–ò–ù --- */
        .login-box {
            background: white; padding: 40px; border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; margin-top: 10vh;
        }
        input[type="text"] {
            font-size: 1.2rem; padding: 10px; border: 2px solid #bdc3c7; border-radius: 5px; width: 80%; margin: 10px 0;
        }

        /* --- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø) --- */
        .top-container {
            background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 10px;
        }
        .top-info-row {
            display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem;
        }
        .criteria-row {
            display: flex; gap: 5px; height: 24px; border-radius: 12px; overflow: hidden;
        }
        .crit-item {
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 0.75rem; font-weight: bold;
            transition: opacity 0.3s;
        }
        /* –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ —à–∫–∞–ª—ã (–¥–ª—è 20 –∑–∞–¥–∞—á) */
        .c-2 { width: 50%; background: var(--error); } /* 0-9 –∑–∞–¥–∞—á */
        .c-3 { width: 20%; background: var(--warning); } /* 10-13 –∑–∞–¥–∞—á */
        .c-4 { width: 20%; background: var(--accent); }  /* 14-17 –∑–∞–¥–∞—á */
        .c-5 { width: 10%; background: var(--success); } /* 18-20 –∑–∞–¥–∞—á */

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        .nav-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-bottom: 20px; }
        @media (max-width: 600px) { .nav-grid { grid-template-columns: repeat(5, 1fr); } }

        .nav-btn {
            background: #bdc3c7; border: none; padding: 8px; border-radius: 4px;
            cursor: pointer; font-weight: bold; font-size: 0.9rem; color: white;
        }
        .nav-btn.active { background: var(--accent); transform: scale(1.1); box-shadow: 0 0 5px var(--accent); }
        .nav-btn.filled { background: var(--dark); } 

        /* --- –ó–ê–î–ê–ß–ê --- */
        .problem-area {
            background: white; padding: 30px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 400px;
        }
        .task-text { font-size: 1.35rem; margin-bottom: 25px; padding-left: 15px; border-left: 6px solid var(--accent); line-height: 1.5; }

        /* --- DRAG & DROP --- */
        .equation-zone {
            min-height: 80px; background: #f8f9fa; border: 2px dashed #bdc3c7;
            border-radius: 8px; display: flex; flex-wrap: wrap; align-items: center; padding: 10px; gap: 8px; margin-bottom: 20px;
        }
        .card {
            background: white; border: 1px solid #bdc3c7; border-bottom-width: 3px;
            padding: 5px 14px; border-radius: 6px; font-weight: bold; cursor: grab; font-size: 1.3rem;
            min-width: 20px; text-align: center;
        }
        .card.number { color: var(--primary); border-color: #95a5a6; }
        .card.variable { background: #e8f6f3; color: #16a085; border-color: #1abc9c; }
        .card.operator { background: #fef9e7; color: #d35400; border-color: #f39c12; }
        .card:active { cursor: grabbing; transform: translateY(2px); border-bottom-width: 1px;}

        .dock { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .dock-label { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; margin-bottom: 8px; display: block; font-weight: bold;}
        .card-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }

        .answer-block { display: flex; align-items: center; gap: 10px; background: #eee; padding: 15px; border-radius: 8px; }
        .answer-input { width: 100px; padding: 5px; font-size: 1.2rem; text-align: center; }

        .btn { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; color: white; transition: 0.2s; }
        .btn-blue { background: var(--accent); }
        .btn-red { background: var(--error); }
        .btn-gray { background: #95a5a6; }
        .btn:hover { opacity: 0.9; }
        .controls { display: flex; justify-content: space-between; margin-top: 20px; }

        /* --- –£–ß–ò–¢–ï–õ–¨–°–ö–ê–Ø --- */
        .teacher-panel { margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: var(--primary); color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .detail-row { display: none; background-color: #fff; }
        .detail-row.open { display: table-row; }
        .detail-content { padding: 15px; border-left: 5px solid var(--accent); }

        /* --- –†–ï–ó–£–õ–¨–¢–ê–¢–´ --- */
        .result-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; background: white; }
        .res-correct { border-left: 5px solid var(--success); }
        .res-wrong { border-left: 5px solid var(--error); }
    </style>
<script src="../../assets/analytics.js"></script>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="login-box">
            <h1>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞</h1>
            <p style="font-size: 1.1rem; color: #7f8c8d;">–¢–µ–º–∞: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ"</p>
            <input type="text" id="studentName" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–∞–º–∏–ª–∏—é –∏ –ò–º—è" autocomplete="off">
            <br><br>
            <button class="btn btn-blue" onclick="startExam()">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
            <div style="margin-top: 50px; font-size: 0.8rem; color: #95a5a6;">
                <span style="cursor: pointer;" onclick="toggleTeacherLogin()">üîí –ñ—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è</span>
            </div>
            <div id="teacherLoginArea" style="display:none; margin-top:10px;">
                <input type="password" id="teacherPass" placeholder="–ü–∞—Ä–æ–ª—å" style="width: 150px;">
                <button class="btn btn-gray" onclick="enterTeacherPanel()">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="screen-exam" class="screen">
        <div class="top-container">
            <div class="top-info-row">
                <div>–£—á–µ–Ω–∏–∫: <b id="displayStudentName"></b></div>
                <div id="timer">–í—Ä–µ–º—è: 00:00</div>
            </div>
            <div class="criteria-row" title="–®–∫–∞–ª–∞ –æ—Ü–µ–Ω–∫–∏">
                <div class="crit-item c-2">–¥–æ 9 –∑–∞–¥–∞—á: "2"</div>
                <div class="crit-item c-3">10-13 –∑–∞–¥–∞—á: "3"</div>
                <div class="crit-item c-4">14-17 –∑–∞–¥–∞—á: "4"</div>
                <div class="crit-item c-5">18+: "5"</div>
            </div>
        </div>

        <div class="nav-grid" id="navGrid"></div>

        <div class="problem-area">
            <div class="task-text" id="taskText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

            <div>
                <span class="dock-label">–ü–æ–ª–µ –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏—è:</span>
                <div class="equation-zone" id="dropZone"></div>
            </div>

            <div class="answer-block">
                <span>–û—Ç–≤–µ—Ç –∑–∞–¥–∞—á–∏: x = </span>
                <input type="number" class="answer-input" id="answerInput" placeholder="?" oninput="saveCurrentProgress()">
            </div>

            <div class="dock">
                <span class="dock-label">–ß–∏—Å–ª–∞ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:</span>
                <div class="card-row" id="valuesContainer"></div>

                <span class="dock-label">–ó–Ω–∞–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π:</span>
                <div class="card-row">
                    <div class="card operator" draggable="true" data-val="+">+</div>
                    <div class="card operator" draggable="true" data-val="-">-</div>
                    <div class="card operator" draggable="true" data-val="*">*</div>
                    <div class="card operator" draggable="true" data-val="/">/</div>
                    <div class="card operator" draggable="true" data-val="=">=</div>
                    <div class="card operator" draggable="true" data-val="(">(</div>
                    <div class="card operator" draggable="true" data-val=")">)</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-gray" onclick="prevQuestion()">‚Üê –ù–∞–∑–∞–¥</button>
            <button class="btn btn-red" onclick="finishExamConfirm()">–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–ë–û–¢–£</button>
            <button class="btn btn-blue" onclick="nextQuestion()">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <div class="login-box" style="width:100%; max-width:800px; text-align: left;">
            <h1 style="text-align: center;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h1>
            <div style="text-align:center; padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;">
                <div id="scoreDisplay"></div>
                <div style="margin-top:10px; font-size:0.9rem; color:#7f8c8d;">–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∂—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è</div>
            </div>
            <div id="detailedResults"></div>
            <button class="btn btn-blue" onclick="location.reload()" style="margin-top:20px; display:block; margin-left:auto; margin-right:auto;">–ù–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
        </div>
    </div>

    <div id="screen-teacher" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>üë®‚Äçüè´ –ü–æ–¥—Ä–æ–±–Ω—ã–π –∂—É—Ä–Ω–∞–ª —Ä–∞–±–æ—Ç</h1>
            <button class="btn btn-gray" onclick="location.reload()">–í—ã–π—Ç–∏</button>
        </div>
        <p style="font-size:0.9rem; color:#7f8c8d;">* –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ —Ü–µ–ª—è—Ö —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏–∏.</p>
        
        <div class="teacher-panel">
            <table id="teacherTable">
                <thead>
                    <tr>
                        <th>–£—á–µ–Ω–∏–∫</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ë–∞–ª–ª—ã</th>
                        <th>–û—Ü–µ–Ω–∫–∞</th>
                        <th>–ù–∞—á–∞–ª–æ</th>
                        <th>–ö–æ–Ω–µ—Ü</th>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–î–µ—Ç–∞–ª–∏</th>
                    </tr>
                </thead>
                <tbody id="teacherTableBody"></tbody>
            </table>
        </div>
    </div>

<script>
    /* ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ================= */
    const TOTAL_QUESTIONS = 20;
    let currentUser = "";
    let currentQIndex = 0;
    let timerInterval = null;
    let session = null;
    const r = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    /* ================= –ì–ï–ù–ï–†–ê–¢–û–† –ó–ê–î–ê–ß ================= */
    function generateVariant() {
        const questions = [];
        const add = (text, x) => {
            const nums = text.match(/\d+([.,]\d+)?/g) || [];
            questions.push({ text: text, solveX: parseFloat(x), extractedNums: nums, userEq: [], userAns: "" });
        };

        // 1-5 (–ë–∞–∑–∞)
        let a = r(15, 40), b = r(10, 30); add(`–Ø –∑–∞–¥—É–º–∞–ª —á–∏—Å–ª–æ. –ï—Å–ª–∏ –∫ –Ω–µ–º—É –ø—Ä–∏–±–∞–≤–∏—Ç—å ${a}, —Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è ${b+a}. –ö–∞–∫–æ–µ —á–∏—Å–ª–æ —è –∑–∞–¥—É–º–∞–ª?`, b);
        let area = r(20, 60), side = r(4, 10); area = side * r(5, 12); add(`–ü–ª–æ—â–∞–¥—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Ä–∞–≤–Ω–∞ ${area} —Å–º¬≤, –∞ –æ–¥–Ω–∞ –∏–∑ –µ–≥–æ —Å—Ç–æ—Ä–æ–Ω —Ä–∞–≤–Ω–∞ ${side} —Å–º. –ù–∞–π–¥–∏—Ç–µ –¥–ª–∏–Ω—É –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã (x).`, area/side);
        let total = r(50, 90), sub = r(10, 30); add(`–ò–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —á–∏—Å–ª–∞ –≤—ã—á–ª–∏ ${sub} –∏ –ø–æ–ª—É—á–∏–ª–∏ ${total - sub}. –ß–µ–º—É —Ä–∞–≤–Ω–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —á–∏—Å–ª–æ?`, total);
        let div_a = r(3,8), div_b = r(6,12); add(`–Ø –∑–∞–¥—É–º–∞–ª —á–∏—Å–ª–æ, —Ä–∞–∑–¥–µ–ª–∏–ª –µ–≥–æ –Ω–∞ ${div_a} –∏ –ø–æ–ª—É—á–∏–ª ${div_b}. –ö–∞–∫–æ–µ —á–∏—Å–ª–æ —è –∑–∞–¥—É–º–∞–ª?`, div_a * div_b);
        let perim = r(10, 20) * 3; add(`–ü–µ—Ä–∏–º–µ—Ç—Ä —Ä–∞–≤–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Ä–∞–≤–µ–Ω ${perim} —Å–º. –û–±–æ–∑–Ω–∞—á—å—Ç–µ —Å—Ç–æ—Ä–æ–Ω—É –∑–∞ x –∏ –Ω–∞–π–¥–∏—Ç–µ –µ—ë –¥–ª–∏–Ω—É.`, perim/3);

        // 6-10 (–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
        let leg = r(10, 25), base = r(5, 15); add(`–ü–µ—Ä–∏–º–µ—Ç—Ä —Ä–∞–≤–Ω–æ–±–µ–¥—Ä–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Ä–∞–≤–µ–Ω ${2*leg+base} —Å–º, –∞ –µ–≥–æ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–≤–Ω–æ ${base} —Å–º. –ù–∞–π–¥–∏—Ç–µ –¥–ª–∏–Ω—É –±–æ–∫–æ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã.`, leg);
        let price = r(20, 50), count = 3, money = price*count + r(15, 60); add(`–ú–∞—à–∞ –∫—É–ø–∏–ª–∞ ${count} —à–æ–∫–æ–ª–∞–¥–∫–∏ –ø–æ ${price} —Ä—É–±–ª–µ–π. –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —É –Ω–µ—ë –æ—Å—Ç–∞–ª–æ—Å—å ${money - price*count} —Ä—É–±–ª–µ–π. –°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ (x) –±—ã–ª–æ —É –ú–∞—à–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ?`, money);
        let k = r(3, 8), m = r(5, 20), val = r(5, 12); add(`–ó–∞–¥—É–º–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ —É–º–Ω–æ–∂–∏–ª–∏ –Ω–∞ ${k}, –∑–∞—Ç–µ–º –∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é –ø—Ä–∏–±–∞–≤–∏–ª–∏ ${m} –∏ –ø–æ–ª—É—á–∏–ª–∏ ${val*k+m}. –ù–∞–π–¥–∏—Ç–µ –∑–∞–¥—É–º–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ.`, val);
        let part1 = r(100, 300), sold = r(20, 50), added = r(10, 40); add(`–ù–∞ —Å–∫–ª–∞–¥–µ –±—ã–ª–æ x –∫–≥ –º—É–∫–∏. –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø—Ä–æ–¥–∞–ª–∏ ${sold} –∫–≥ –∏ –ø—Ä–∏–≤–µ–∑–ª–∏ –µ—â—ë ${added} –∫–≥, –Ω–∞ —Å–∫–ª–∞–¥–µ —Å—Ç–∞–ª–æ ${part1 - sold + added} –∫–≥. –°–∫–æ–ª—å–∫–æ –º—É–∫–∏ –±—ã–ª–æ –≤–Ω–∞—á–∞–ª–µ?`, part1);
        let v1 = r(50, 70), v2 = r(60, 80), t = r(2, 5); add(`–ò–∑ –¥–≤—É—Ö –≥–æ—Ä–æ–¥–æ–≤ –Ω–∞–≤—Å—Ç—Ä–µ—á—É –¥—Ä—É–≥ –¥—Ä—É–≥—É –≤—ã–µ—Ö–∞–ª–∏ –¥–≤–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è. –°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ ${v1} –∫–º/—á, —Å–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ ${v2} –∫–º/—á. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏ ${(v1+v2)*t} –∫–º. –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ (x) –æ–Ω–∏ –≤—Å—Ç—Ä–µ—Ç—è—Ç—Å—è?`, t);

        // 11-15 (–°—é–∂–µ—Ç—ã)
        let son = r(8, 15); add(`–û—Ç–µ—Ü —Å—Ç–∞—Ä—à–µ —Å—ã–Ω–∞ –≤ 4 —Ä–∞–∑–∞. –°—É–º–º–∞ –∏—Ö –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ —Ä–∞–≤–Ω–∞ ${son + 4*son} –ª–µ—Ç. –°–∫–æ–ª—å–∫–æ –ª–µ—Ç —Å—ã–Ω—É (x)?`, son);
        let speedBoat = r(12, 18), speedRiver = r(2, 4), time = 3; add(`–ö–∞—Ç–µ—Ä –ø—Ä–æ—à—ë–ª –ø–æ —Ç–µ—á–µ–Ω–∏—é —Ä–µ–∫–∏ –∑–∞ ${time} —á–∞—Å–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ ${(speedBoat+speedRiver)*time} –∫–º. –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∫–∞—Ç–µ—Ä–∞ ${speedBoat} –∫–º/—á. –ù–∞–π–¥–∏—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å —Ç–µ—á–µ–Ω–∏—è —Ä–µ–∫–∏ (x).`, speedRiver);
        add(`–ù–∞–π–¥–∏—Ç–µ –∫–æ—Ä–µ–Ω—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è: 100 : (x - 5) = 20`, 10);
        let width = r(10, 30), length = width + r(5, 15); add(`–ü–µ—Ä–∏–º–µ—Ç—Ä –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ —Ä–∞–≤–µ–Ω ${2*(width+length)} –º. –ï–≥–æ –¥–ª–∏–Ω–∞ –Ω–∞ ${length-width} –º –±–æ–ª—å—à–µ —à–∏—Ä–∏–Ω—ã (x). –ù–∞–π–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É.`, width);
        let num1 = r(10, 20), d1 = 5, d2 = 10; add(`–°—É–º–º–∞ —Ç—Ä–µ—Ö —á–∏—Å–µ–ª —Ä–∞–≤–Ω–∞ ${num1 + (num1+d1) + (num1+d2)}. –ü–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ x, –≤—Ç–æ—Ä–æ–µ –Ω–∞ ${d1} –±–æ–ª—å—à–µ –ø–µ—Ä–≤–æ–≥–æ, –∞ —Ç—Ä–µ—Ç—å–µ –Ω–∞ ${d2} –±–æ–ª—å—à–µ –ø–µ—Ä–≤–æ–≥–æ. –ù–∞–π–¥–∏—Ç–µ x.`, num1);

        // 16-20 (–ü—Ä–æ—Ñ–∏)
        let x16 = r(5, 15), factor = r(3, 6), sub16 = r(1, 4), right16 = factor * (x16 - sub16);
        add(`–†–µ—à–∏—Ç–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ: ${factor} * (x - ${sub16}) = ${right16}`, x16);
        let x17 = 10, A = r(5, 15), B = 20 - A; 
        add(`–ù–∞ –ø–µ—Ä–≤–æ–π –ø–æ–ª–∫–µ –±—ã–ª–æ –≤ 3 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –∫–Ω–∏–≥, —á–µ–º –Ω–∞ –≤—Ç–æ—Ä–æ–π (x). –ö–æ–≥–¥–∞ —Å –ø–µ—Ä–≤–æ–π –ø–æ–ª–∫–∏ —Å–Ω—è–ª–∏ ${A} –∫–Ω–∏–≥, –∞ –Ω–∞ –≤—Ç–æ—Ä—É—é –ø–æ—Å—Ç–∞–≤–∏–ª–∏ ${B} –∫–Ω–∏–≥, –∏—Ö —Å—Ç–∞–ª–æ –ø–æ—Ä–æ–≤–Ω—É. –°–∫–æ–ª—å–∫–æ –∫–Ω–∏–≥ –±—ã–ª–æ –Ω–∞ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–∫–µ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ?`, x17);
        let totalMoney = r(1, 5) * 1000, percent = 40, remain = totalMoney * 0.6;
        add(`–¢—É—Ä–∏—Å—Ç –ø–æ—Ç—Ä–∞—Ç–∏–ª ${percent}% –∏–º–µ–≤—à–∏—Ö—Å—è —É –Ω–µ–≥–æ –¥–µ–Ω–µ–≥, –∏ —É –Ω–µ–≥–æ –æ—Å—Ç–∞–ª–æ—Å—å ${remain} —Ä—É–±–ª–µ–π. –°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ (x) –±—ã–ª–æ —É —Ç—É—Ä–∏—Å—Ç–∞?`, totalMoney);
        let riverV = 2, boatV = 14; 
        add(`–ö–∞—Ç–µ—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ —Ç–µ—á–µ–Ω–∏—é —Ä–µ–∫–∏ –∑–∞ 3 —á–∞—Å–∞, –∞ –ø—Ä–æ—Ç–∏–≤ —Ç–µ—á–µ–Ω–∏—è ‚Äî –∑–∞ 4 —á–∞—Å–∞. –°–∫–æ—Ä–æ—Å—Ç—å —Ç–µ—á–µ–Ω–∏—è —Ä–µ–∫–∏ ${riverV} –∫–º/—á. –ù–∞–π–¥–∏—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –∫–∞—Ç–µ—Ä–∞ (x).`, boatV);
        let x20 = r(3, 9), neededSum = 5 * x20, RHS_offset = r(5, neededSum - 5), LHS_offset = neededSum - RHS_offset;
        add(`–ù–∞–π–¥–∏—Ç–µ –∫–æ—Ä–µ–Ω—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è: 4x + 3x - ${LHS_offset} = 2x + ${RHS_offset}`, x20);

        return questions;
    }

    /* ================= –°–ò–°–¢–ï–ú–ê ================= */
    function loadState() {
        const saved = localStorage.getItem('mathExam_v3_db');
        return saved ? JSON.parse(saved) : {}; 
    }
    function saveDB(db) {
        localStorage.setItem('mathExam_v3_db', JSON.stringify(db));
    }

    function startExam() {
        const nameInput = document.getElementById('studentName');
        const name = nameInput.value.trim();
        if (!name) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –§–∞–º–∏–ª–∏—é –∏ –ò–º—è!"); return; }
        
        currentUser = name;
        const db = loadState();

        if (db[name] && db[name].status === 'finished') {
            alert("–≠—Ç–æ—Ç —É—á–µ–Ω–∏–∫ —É–∂–µ —Å–¥–∞–ª —Ä–∞–±–æ—Ç—É!"); return;
        }

        if (db[name]) {
            if(!confirm(`–ù–∞–π–¥–µ–Ω–∞ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–ª—è ${name}. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) return;
            session = db[name];
        } else {
            session = { user: name, status: "in_progress", startTime: Date.now(), questions: generateVariant() };
            db[name] = session;
            saveDB(db);
        }

        document.getElementById('displayStudentName').textContent = currentUser;
        switchScreen('screen-exam');
        initNavGrid();
        loadQuestion(0);
        startTimer();
    }

    function saveCurrentProgress() {
        if (!session) return;
        const q = session.questions[currentQIndex];
        q.userAns = document.getElementById('answerInput').value;
        q.userEq = Array.from(document.getElementById('dropZone').children).map(c => c.dataset.val);
        const db = loadState(); db[currentUser] = session; saveDB(db);
        updateNavStatus(currentQIndex);
    }

    /* ================= –ò–ù–¢–ï–†–§–ï–ô–° ================= */
    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function initNavGrid() {
        const grid = document.getElementById('navGrid'); grid.innerHTML = '';
        for (let i = 0; i < TOTAL_QUESTIONS; i++) {
            const btn = document.createElement('button');
            btn.className = 'nav-btn'; btn.textContent = i + 1;
            btn.onclick = () => { saveCurrentProgress(); loadQuestion(i); };
            btn.id = `nav-btn-${i}`; grid.appendChild(btn);
        }
        updateAllNavStatuses();
    }

    function updateNavStatus(idx) {
        const q = session.questions[idx];
        const btn = document.getElementById(`nav-btn-${idx}`);
        if (q.userAns !== "" || q.userEq.length > 0) btn.classList.add('filled');
        else btn.classList.remove('filled');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(document.getElementById(`nav-btn-${currentQIndex}`)) document.getElementById(`nav-btn-${currentQIndex}`).classList.add('active');
    }
    function updateAllNavStatuses() { session.questions.forEach((q, i) => updateNavStatus(i)); }

    function loadQuestion(idx) {
        currentQIndex = idx;
        const q = session.questions[idx];
        document.getElementById('taskText').innerHTML = q.text;
        document.getElementById('answerInput').value = q.userAns;

        const dropZone = document.getElementById('dropZone'); dropZone.innerHTML = '';
        q.userEq.forEach(val => {
            let type = 'number';
            if (['+', '-', '*', '/', '=', '(', ')'].includes(val)) type = 'operator';
            else if (val === 'x') type = 'variable';
            createDraggableCard(val, type, dropZone);
        });

        const valuesContainer = document.getElementById('valuesContainer'); valuesContainer.innerHTML = '';
        createDraggableCard('x', 'variable', valuesContainer, true);
        if (q.extractedNums) {
            [...new Set(q.extractedNums)].forEach(n => createDraggableCard(n.replace(',', '.'), 'number', valuesContainer, true));
        }
        updateAllNavStatuses();
    }

    function createDraggableCard(text, type, container, isSource = false) {
        const el = document.createElement('div'); el.className = `card ${type}`; el.draggable = true; el.textContent = text; el.dataset.val = text;
        if (isSource) {
            el.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', JSON.stringify({val: text, type: type})); e.dataTransfer.effectAllowed = 'copy'; });
        } else {
            el.onclick = function() { this.remove(); saveCurrentProgress(); };
        }
        container.appendChild(el);
    }
    function nextQuestion() { if (currentQIndex < TOTAL_QUESTIONS - 1) { saveCurrentProgress(); loadQuestion(currentQIndex + 1); } }
    function prevQuestion() { if (currentQIndex > 0) { saveCurrentProgress(); loadQuestion(currentQIndex - 1); } }

    /* ================= DRAG & DROP ================= */
    document.addEventListener('DOMContentLoaded', () => {
        const dropZone = document.getElementById('dropZone');
        document.querySelectorAll('.card.operator').forEach(el => {
            el.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', JSON.stringify({val: el.dataset.val, type: 'operator'})); });
        });
        dropZone.addEventListener('dragover', e => e.preventDefault());
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const dataRaw = e.dataTransfer.getData('text/plain'); if (!dataRaw) return;
            const data = JSON.parse(dataRaw);
            createDraggableCard(data.val, data.type, dropZone);
            saveCurrentProgress();
        });
    });

    /* ================= –ó–ê–í–ï–†–®–ï–ù–ò–ï ================= */
    function startTimer() {
        const timerEl = document.getElementById('timer');
        timerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - session.startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            timerEl.textContent = `–í—Ä–µ–º—è: ${m}:${s}`;
        }, 1000);
    }

    function finishExamConfirm() {
        saveCurrentProgress();
        const empty = session.questions.filter(q => q.userAns === "").length;
        if (confirm(`–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É?${empty > 0 ? `\n\n–ù–µ —Ä–µ—à–µ–Ω–æ –∑–∞–¥–∞—á: ${empty}` : ''}`)) finishExam();
    }

    function finishExam() {
        clearInterval(timerInterval);
        session.status = "finished";
        session.finishTime = Date.now();
        
        let correctCount = 0;
        session.questions.forEach(q => {
            const userVal = parseFloat(q.userAns.replace(',', '.'));
            q.isCorrect = Math.abs(userVal - q.solveX) < 0.1;
            if (q.isCorrect) correctCount++;
        });

        session.score = correctCount;
        saveDB({ ...loadState(), [currentUser]: session });
        showResults();
    }

    function showResults() {
        switchScreen('screen-results');
        const pct = Math.round((session.score / TOTAL_QUESTIONS) * 100);
        let mark = 2;
        if (pct >= 50) mark = 3;
        if (pct >= 70) mark = 4;
        if (pct >= 90) mark = 5;

        let color = '#e74c3c';
        if(mark===3) color='#f39c12';
        if(mark===4) color='#3498db';
        if(mark===5) color='#27ae60';

        document.getElementById('scoreDisplay').innerHTML = `
            –í–µ—Ä–Ω–æ –∑–∞–¥–∞–Ω–∏–π: ${session.score} –∏–∑ ${TOTAL_QUESTIONS}<br>
            <span style="font-size: 4rem; color: ${color}; font-weight:bold;">${mark}</span>
        `;

        const container = document.getElementById('detailedResults');
        container.innerHTML = '';
        session.questions.forEach((q, i) => {
            const div = document.createElement('div');
            div.className = `result-card ${q.isCorrect ? 'res-correct' : 'res-wrong'}`;
            div.innerHTML = `
                <b>‚Ññ${i+1}</b> ${q.isCorrect ? '<span style="color:green">–í–µ—Ä–Ω–æ</span>' : '<span style="color:red">–û—à–∏–±–∫–∞</span>'}<br>
                <small>${q.text}</small><br>
                –û—Ç–≤–µ—Ç: <b>${q.userAns}</b> (–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${q.solveX})
            `;
            container.appendChild(div);
        });
    }

    /* ================= –ü–ê–ù–ï–õ–¨ –£–ß–ò–¢–ï–õ–Ø ================= */
    function toggleTeacherLogin() {
        const area = document.getElementById('teacherLoginArea');
        area.style.display = area.style.display === 'none' ? 'block' : 'none';
    }
    function enterTeacherPanel() {
        if (document.getElementById('teacherPass').value === '1234') {
            renderTeacherTable();
            switchScreen('screen-teacher');
        } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    }
    
    function renderTeacherTable() {
        const db = loadState();
        const tbody = document.getElementById('teacherTableBody');
        tbody.innerHTML = '';
        
        Object.keys(db).forEach((name, index) => {
            const s = db[name];
            
            let duration = "...";
            if (s.finishTime && s.startTime) {
                const diffMin = Math.floor((s.finishTime - s.startTime) / 60000);
                duration = diffMin + " –º–∏–Ω.";
            }

            let mark = "-";
            if (s.status === 'finished') {
                const pct = (s.score / TOTAL_QUESTIONS) * 100;
                if (pct < 50) mark = 2;
                else if (pct < 70) mark = 3;
                else if (pct < 90) mark = 4;
                else mark = 5;
            }

            const tr = document.createElement('tr');
            const startStr = new Date(s.startTime).toLocaleTimeString();
            const endStr = s.finishTime ? new Date(s.finishTime).toLocaleTimeString() : "-";
            
            tr.innerHTML = `
                <td><b>${s.user}</b></td>
                <td>${s.status === 'finished' ? '<span style="color:green">–°–¥–∞–ª</span>' : '<span style="color:orange">–ü–∏—à–µ—Ç...</span>'}</td>
                <td>${s.status === 'finished' ? s.score : '0'} / ${TOTAL_QUESTIONS}</td>
                <td style="font-weight:bold; font-size:1.1rem;">${mark}</td>
                <td>${startStr}</td>
                <td>${endStr}</td>
                <td>${duration}</td>
                <td><button class="btn btn-blue" style="padding:4px 8px; font-size:0.8rem" onclick="toggleDetail('detail-${index}')">–ü—Ä–æ—Å–º–æ—Ç—Ä</button></td>
            `;
            tbody.appendChild(tr);

            const detailTr = document.createElement('tr');
            detailTr.className = 'detail-row';
            detailTr.id = `detail-${index}`;
            
            let answersHtml = s.questions.map((q, i) => {
                const eqStr = q.userEq.join(' ') || "(–ø—É—Å—Ç–æ)";
                return `<div style="margin-bottom:5px; padding-bottom:5px; border-bottom:1px solid #eee;">
                    <b>‚Ññ${i+1}</b> ${q.isCorrect ? '‚úÖ' : '‚ùå'} | –û—Ç–≤–µ—Ç: ${q.userAns} (–í–µ—Ä–Ω–æ: ${q.solveX}) | –£—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${eqStr}
                </div>`;
            }).join('');

            detailTr.innerHTML = `<td colspan="8">
                <div class="detail-content">
                    <h4>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: ${s.user}</h4>
                    ${answersHtml}
                </div>
            </td>`;
            tbody.appendChild(detailTr);
        });
    }

    function toggleDetail(id) {
        const row = document.getElementById(id);
        row.classList.toggle('open');
    }
</script>
</body>

</html>
