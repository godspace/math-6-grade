<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Å—Ç–µ—Ä –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç Pro (Fixed)</title>
    <style>
        :root {
            --primary: #4361ee;
            --accent: #f72585;
            --bg-body: #edf2f4;
            --bg-card: #ffffff;
            --text-main: #2b2d42;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            margin: 0;
            padding: 15px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: var(--text-main);
            /* –ó–∞–ø—Ä–µ—Ç –∑—É–º–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏–≥—Ä—ã */
            touch-action: manipulation; 
        }

        .app-container {
            width: 100%;
            max-width: 900px;
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- TABS --- */
        .tabs-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 0 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #8d99ae;
            cursor: pointer;
            transition: 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #fff;
        }

        /* --- TASK --- */
        .task-area {
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .score-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e0e7ff;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .question {
            font-size: 1.4rem;
            margin-bottom: 8px;
        }

        .math-tag {
            background: #eef2ff;
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: bold;
            border: 1px solid #c7d2fe;
        }

        .feedback {
            height: 24px;
            font-size: 1rem;
            font-weight: 600;
        }
        .correct { color: #10b981; }
        .wrong { color: #ef4444; }

        /* --- CANVAS --- */
        .canvas-container {
            position: relative;
            width: 100%;
            height: 260px;
            background: radial-gradient(circle, #fff 0%, #fcfcfc 100%);
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            /* –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–•: –æ—Ç–∫–ª—é—á–∞–µ—Ç —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏ –∫–∞–Ω–≤–∞—Å–∞ */
            touch-action: none; 
            cursor: grab;
        }
        canvas:active { cursor: grabbing; }

        /* --- CONTROLS --- */
        .controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            min-height: 80px;
            background: #fff;
        }

        input {
            padding: 10px;
            font-size: 1.2rem;
            width: 120px;
            text-align: center;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        input:focus { border-color: var(--primary); outline: none; }

        .btn {
            padding: 10px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-check { background: var(--primary); }
        .btn-next { background: #374151; display: none; }

    </style>
</head>
<body>

<div class="app-container">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="App.setMode('locate')">üìç –ù–∞–π—Ç–∏ —Ç–æ—á–∫—É</button>
        <button class="tab-btn" onclick="App.setMode('read')">üëÄ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞</button>
        <button class="tab-btn" onclick="App.setMode('distance')">üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</button>
    </div>

    <div class="task-area">
        <div class="score-badge">–°—á—ë—Ç: <span id="scoreVal">0</span></div>
        <div class="question" id="questionBox">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="feedback" id="feedbackBox"></div>
    </div>

    <div class="canvas-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div class="controls" id="controlsBox"></div>
</div>

<script>
    const App = {
        canvas: document.getElementById('gameCanvas'),
        ctx: null,
        width: 0,
        height: 0,
        dpr: 1,

        state: {
            mode: 'locate',
            score: 0,
            scale: 50,      // –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É
            offsetX: 0,     // —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞
            
            points: [],     // –æ–±—ä–µ–∫—Ç—ã { val, label, color, draggable }
            
            target: 0,      // —Ü–µ–ª—å (–¥–ª—è locate)
            correct: 0,     // –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–¥–ª—è read/distance)
            
            isDragging: false,
            dragItem: null,
            solved: false
        },

        ui: {
            question: document.getElementById('questionBox'),
            feedback: document.getElementById('feedbackBox'),
            score: document.getElementById('scoreVal'),
            controls: document.getElementById('controlsBox')
        },

        init() {
            this.ctx = this.canvas.getContext('2d');
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–∫—Ä–∞–Ω–∞
            this.handleResize();
            window.addEventListener('resize', () => this.handleResize());

            // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô (MOUSE & TOUCH) ---
            const startHandler = (e) => this.onDown(e);
            const moveHandler = (e) => this.onMove(e);
            const endHandler = (e) => this.onUp(e);

            this.canvas.addEventListener('mousedown', startHandler);
            this.canvas.addEventListener('touchstart', startHandler, {passive: false});

            window.addEventListener('mousemove', moveHandler);
            window.addEventListener('touchmove', moveHandler, {passive: false});

            window.addEventListener('mouseup', endHandler);
            window.addEventListener('touchend', endHandler);

            this.setMode('locate');
            this.loop();
        },

        handleResize() {
            const rect = this.canvas.parentElement.getBoundingClientRect();
            this.width = rect.width;
            this.height = rect.height;
            
            // –†–∞–±–æ—Ç–∞ —Å Retina –¥–∏—Å–ø–ª–µ—è–º–∏
            this.dpr = window.devicePixelRatio || 1;
            this.canvas.width = this.width * this.dpr;
            this.canvas.height = this.height * this.dpr;
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã —Ä–∏—Å–æ–≤–∞—Ç—å –≤ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–∏–∫—Å–µ–ª—è—Ö
            this.ctx.scale(this.dpr, this.dpr);
            
            this.state.offsetX = this.width / 2;
        },

        setMode(mode) {
            this.state.mode = mode;
            this.state.score = 0;
            this.ui.score.textContent = 0;
            
            // UI —Ç–∞–±–æ–≤
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const idx = mode === 'locate' ? 0 : mode === 'read' ? 1 : 2;
            document.querySelectorAll('.tab-btn')[idx].classList.add('active');

            this.nextLevel();
        },

        nextLevel() {
            this.state.solved = false;
            this.state.points = [];
            this.ui.feedback.textContent = '';
            this.ui.controls.innerHTML = '';

            const btnCheck = document.createElement('button');
            btnCheck.className = 'btn btn-check';
            btnCheck.textContent = '–ü–†–û–í–ï–†–ò–¢–¨';
            btnCheck.onclick = () => this.check();

            const btnNext = document.createElement('button');
            btnNext.className = 'btn btn-next';
            btnNext.textContent = '–î–ê–õ–¨–®–ï ‚Üí';
            btnNext.onclick = () => this.nextLevel();
            this.btnNextRef = btnNext;
            this.btnCheckRef = btnCheck;

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
            const isDecimal = Math.random() > 0.5;
            this.state.scale = isDecimal ? 200 : 50; // –ú–∞—Å—à—Ç–∞–± (Zoom)

            if (this.state.mode === 'locate') {
                let val = isDecimal 
                    ? parseFloat((Math.random() * 2.4 - 1.2).toFixed(1)) 
                    : Math.floor(Math.random() * 16 - 8);
                
                this.state.target = val;
                this.ui.question.innerHTML = `–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–ª–∞–∂–æ–∫ –≤ —Ç–æ—á–∫—É <span class="math-tag">A(${val})</span>`;

                // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è —Å—Ç–∞—Ä—Ç–∞ (–Ω–µ –≤ –æ—Ç–≤–µ—Ç–µ)
                let start = 0;
                do {
                    start = isDecimal ? (Math.random()*2 - 1) : Math.floor(Math.random()*10 - 5);
                } while(Math.abs(start - val) < 0.5);

                this.state.points.push({
                    val: start, label: 'A', color: '#f72585', draggable: true
                });

                this.ui.controls.appendChild(btnCheck);
                this.ui.controls.appendChild(btnNext);

            } else if (this.state.mode === 'read') {
                let val = isDecimal 
                    ? parseFloat((Math.random() * 2.4 - 1.2).toFixed(1)) 
                    : Math.floor(Math.random() * 14 - 7);
                
                this.state.correct = val;
                this.ui.question.innerHTML = `–ö–∞–∫–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —É —Ç–æ—á–∫–∏ <span class="math-tag" style="color:#4361ee">K</span>?`;

                this.state.points.push({
                    val: val, label: 'K', color: '#4361ee', draggable: false
                });

                const inp = document.createElement('input');
                inp.type = 'number';
                inp.id = 'ansInput';
                this.ui.controls.appendChild(inp);
                this.ui.controls.appendChild(btnCheck);
                this.ui.controls.appendChild(btnNext);
                setTimeout(()=>inp.focus(), 100);

            } else { // distance
                let a = isDecimal ? parseFloat((Math.random()*2-1).toFixed(1)) : Math.floor(Math.random()*12-6);
                let b = isDecimal ? parseFloat((Math.random()*2-1).toFixed(1)) : Math.floor(Math.random()*12-6);
                if (a===b) b = a+2;
                
                this.state.correct = parseFloat(Math.abs(a - b).toFixed(2));
                this.ui.question.innerHTML = `–ù–∞–π–¥–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É <span class="math-tag">A(${a})</span> –∏ <span class="math-tag">B(${b})</span>`;
                
                this.state.points.push({ val: a, label: 'A', color: '#7209b7', draggable: false });
                this.state.points.push({ val: b, label: 'B', color: '#7209b7', draggable: false });

                const inp = document.createElement('input');
                inp.type = 'number';
                inp.id = 'ansInput';
                this.ui.controls.appendChild(inp);
                this.ui.controls.appendChild(btnCheck);
                this.ui.controls.appendChild(btnNext);
            }
        },

        check() {
            if (this.state.solved) return;
            let isOk = false;
            let rightAns = '';

            if (this.state.mode === 'locate') {
                const p = this.state.points[0];
                const diff = Math.abs(p.val - this.state.target);
                // –î–æ–ø—É—Å–∫
                isOk = diff < (this.state.scale > 100 ? 0.05 : 0.15);
                rightAns = this.state.target;
                if (isOk) p.val = this.state.target; // –ü—Ä–∏–º–∞–≥–Ω–∏—Ç–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ
                else {
                    // –ü–æ–∫–∞–∑–∞—Ç—å –≥–¥–µ –Ω–∞–¥–æ –±—ã–ª–æ
                    this.state.points.push({
                        val: this.state.target, label: '‚úî', color: '#10b981', draggable: false, ghost: true
                    });
                }
            } else {
                const inp = document.getElementById('ansInput');
                const val = parseFloat(inp.value);
                if(isNaN(val)) return;
                isOk = Math.abs(val - this.state.correct) < 0.001;
                rightAns = this.state.correct;
            }

            if (isOk) {
                this.ui.feedback.innerHTML = '<span class="correct">–í–µ—Ä–Ω–æ! –ú–æ–ª–æ–¥–µ—Ü.</span>';
                this.state.score++;
                this.ui.score.textContent = this.state.score;
            } else {
                this.ui.feedback.innerHTML = `<span class="wrong">–û—à–∏–±–∫–∞. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${rightAns}</span>`;
            }

            this.state.solved = true;
            this.btnCheckRef.style.display = 'none';
            this.btnNextRef.style.display = 'block';
        },

        // --- –õ–û–ì–ò–ö–ê –í–í–û–î–ê (FIXED) ---
        getPos(e) {
            const rect = this.canvas.getBoundingClientRect();
            // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ø–∞–ª–µ—Ü –∏–ª–∏ –º—ã—à—å
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            // –í–∞–∂–Ω–æ: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏ (CSS pixels)
            return cx - rect.left;
        },

        onDown(e) {
            if (this.state.solved) return;
            // e.preventDefault(); // –ú–æ–∂–Ω–æ –Ω–µ –æ—Ç–º–µ–Ω—è—Ç—å –¥–µ—Ñ–æ–ª—Ç —Ç—É—Ç, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –∏–Ω–ø—É—Ç—ã –≤–Ω–µ –∫–∞–Ω–≤–∞—Å–∞
            
            const x = this.getPos(e);
            const ox = this.state.offsetX;
            const sc = this.state.scale;

            // –ü–æ–∏—Å–∫ —Ç–æ—á–∫–∏ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
            for (let p of this.state.points) {
                if (p.draggable) {
                    const px = ox + p.val * sc;
                    // –ó–æ–Ω–∞ –∫–ª–∏–∫–∞ +/- 40px (–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö)
                    if (Math.abs(x - px) < 40) {
                        this.state.isDragging = true;
                        this.state.dragItem = p;
                        this.canvas.style.cursor = 'grabbing';
                        return;
                    }
                }
            }
        },

        onMove(e) {
            if (!this.state.isDragging) return;
            e.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥—Ä–∞–≥–µ

            const x = this.getPos(e);
            const ox = this.state.offsetX;
            const sc = this.state.scale;

            // –û–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è: –ø–∏–∫—Å–µ–ª–∏ -> –∑–Ω–∞—á–µ–Ω–∏–µ
            let rawVal = (x - ox) / sc;

            // –ú–∞–≥–Ω–∏—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ (Snap)
            const step = (sc > 100) ? 0.1 : 0.5;
            const snapped = Math.round(rawVal / step) * step;
            
            // –ï—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ –¥–µ–ª–µ–Ω–∏—é, –º–∞–≥–Ω–∏—Ç–∏–º
            if (Math.abs(rawVal - snapped) < step * 0.4) {
                rawVal = snapped;
            }

            // –ì—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
            const maxVal = (this.width - ox) / sc;
            const minVal = -ox / sc;
            rawVal = Math.max(minVal + 0.5, Math.min(maxVal - 0.5, rawVal));

            this.state.dragItem.val = rawVal;
        },

        onUp(e) {
            this.state.isDragging = false;
            this.state.dragItem = null;
            this.canvas.style.cursor = 'grab';
        },

        // --- –û–¢–†–ò–°–û–í–ö–ê ---
        loop() {
            this.draw();
            requestAnimationFrame(() => this.loop());
        },

        draw() {
            const ctx = this.ctx;
            const w = this.width;
            const h = this.height;
            const ox = this.state.offsetX;
            const sc = this.state.scale;
            const cy = h / 2 + 20;

            // –û—á–∏—Å—Ç–∫–∞
            ctx.clearRect(0, 0, w, h);

            // 1. –û—Å—å
            ctx.beginPath();
            ctx.moveTo(0, cy);
            ctx.lineTo(w, cy);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            // –°—Ç—Ä–µ–ª–∫–∞
            ctx.beginPath();
            ctx.moveTo(w-10, cy-5);
            ctx.lineTo(w, cy);
            ctx.lineTo(w-10, cy+5);
            ctx.fill();

            // 2. –î–µ–ª–µ–Ω–∏—è
            const minV = -ox/sc;
            const maxV = (w-ox)/sc;
            
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.font = 'bold 14px sans-serif';
            ctx.fillStyle = '#6b7280';

            // –¶–µ–ª—ã–µ
            for (let i = Math.floor(minV); i <= Math.ceil(maxV); i++) {
                const px = ox + i * sc;
                ctx.beginPath();
                ctx.moveTo(px, cy-8);
                ctx.lineTo(px, cy+8);
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fillText(i, px, cy+15);
            }

            // –î—Ä–æ–±–Ω—ã–µ (–µ—Å–ª–∏ –∑—É–º –±–æ–ª—å—à–æ–π)
            if (sc > 80) {
                const step = sc > 180 ? 0.1 : 0.5;
                for (let j = Math.floor(minV/step); j <= Math.ceil(maxV/step); j++) {
                    const v = j * step;
                    if (Math.abs(Math.round(v)-v) < 0.001) continue;
                    const px = ox + v * sc;
                    ctx.beginPath();
                    ctx.moveTo(px, cy-4);
                    ctx.lineTo(px, cy+4);
                    ctx.strokeStyle = '#9ca3af';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            // 3. –î—É–≥–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
            if (this.state.mode === 'distance' && this.state.points.length >= 2) {
                const p1 = this.state.points[0];
                const p2 = this.state.points[1];
                const x1 = ox + p1.val * sc;
                const x2 = ox + p2.val * sc;
                const mid = (x1+x2)/2;
                
                ctx.beginPath();
                ctx.moveTo(x1, cy-40);
                ctx.quadraticCurveTo(mid, cy-80, x2, cy-40);
                ctx.strokeStyle = '#7209b7';
                ctx.lineWidth = 2;
                ctx.setLineDash([5,5]);
                ctx.stroke();
                ctx.setLineDash([]);

                // –¢–µ–∫—Å—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                const txt = this.state.solved ? this.state.correct : "?";
                ctx.fillStyle = "#fff";
                ctx.fillRect(mid-15, cy-80, 30, 20); // –ø–æ–¥–ª–æ–∂–∫–∞
                ctx.fillStyle = "#7209b7";
                ctx.fillText(txt, mid, cy-75);
            }

            // 4. –¢–æ—á–∫–∏ (–ö–∞–ø–ª–∏)
            for (let p of this.state.points) {
                const x = ox + p.val * sc;
                const y = cy;
                
                ctx.globalAlpha = p.ghost ? 0.5 : 1;
                
                // –ù–æ–∂–∫–∞
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x, y-35);
                ctx.strokeStyle = p.color;
                ctx.lineWidth = 2;
                ctx.stroke();

                // –ì–æ–ª–æ–≤–∞
                ctx.beginPath();
                ctx.arc(x, y-35, 14, Math.PI-0.5, 0.5); // –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å
                ctx.lineTo(x, y); // –û—Å—Ç—Ä–∏–µ –≤–Ω–∏–∑
                ctx.fillStyle = p.color;
                
                // –¢–µ–Ω—å
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.shadowBlur = 5;
                ctx.shadowOffsetY = 3;
                ctx.fill();
                ctx.shadowColor = 'transparent';

                // –õ–µ–π–±–ª
                ctx.fillStyle = '#fff';
                ctx.fillText(p.label, x, y-42);

                // –û–±–≤–æ–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
                if (p.draggable && !this.state.solved) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.8)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                ctx.globalAlpha = 1;
            }
        }
    };

    App.init();
</script>
</body>
</html>