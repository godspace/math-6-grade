<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Å—Ç–µ—Ä –ü—Ä–æ—Ü–µ–Ω—Ç–æ–≤: –°—é–∂–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º</title>
    <style>
        :root {
            --primary: #4361ee;
            --success: #2ec4b6;
            --warning: #ff9f1c;
            --danger: #e71d36;
            --percent-color: #9d4edd;
            --bg-gradient: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 1100px;
            padding: 40px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* –®–∞–ø–∫–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .level-badges {
            display: flex;
            gap: 10px;
        }

        .lvl-badge {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s;
        }

        .lvl-badge.active { background: var(--primary); transform: scale(1.2); box-shadow: 0 0 10px var(--primary); }
        .lvl-badge.completed { background: var(--success); }

        .stats-box {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: bold;
            color: var(--primary);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        h1 { margin: 0; color: #2d3436; font-size: 1.8rem; }
        .subtitle { color: #636e72; margin-top: 5px; }

        /* –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å */
        .work-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            min-height: 350px; /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–æ */
        }

        /* –ê–ù–ò–ú–ê–¶–ò–Ø –ü–û–Ø–í–õ–ï–ù–ò–Ø */
        .fade-element {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
            pointer-events: none;
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞–ª–æ –º–µ—Å—Ç–æ */
        }

        .fade-element.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            display: flex; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º display */
        }
        
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è –±–ª–æ–∫–∞ –∏–Ω–ø—É—Ç–æ–≤, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ */
        #inputSection.visible {
            display: flex;
        }

        .task-statement {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            font-size: 1.4rem;
            line-height: 1.6;
            margin-bottom: 0px;
            border-left: 5px solid var(--percent-color);
            width: 90%;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* –ö—É—Ä—Å–æ—Ä –ø–µ—á–∞—Ç–Ω–æ–π –º–∞—à–∏–Ω–∫–∏ */
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: var(--primary);
        }
        
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è */
        .visual-container {
            width: 80%;
            background: #fff;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        canvas#visualCanvas {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            background: #f0f0f0;
        }

        .highlight-percent { color: var(--percent-color); font-weight: bold; }
        .highlight-number { color: var(--primary); font-weight: bold; }

        .fraction-row {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 2rem;
            font-weight: bold;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }

        .fraction {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
        }

        .frac-num, .frac-den { padding: 5px; }
        .frac-line { width: 100%; height: 4px; background: #333; border-radius: 2px; }
        
        .operator { font-size: 2.5rem; color: var(--primary); }

        /* –û–±–ª–∞—Å—Ç—å —Ä–∞–∑–ª–æ–∂–µ–Ω–∏—è */
        .factorization-area {
            background: #fff;
            padding: 25px;
            border-radius: 16px;
            border: 2px dashed #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            transition: border-color 0.3s;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
        }

        .factors-container {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            min-height: 60px;
        }

        .factor-input {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            outline: none;
            transition: all 0.2s;
            font-weight: bold;
            color: #333;
            background: #fff;
            -moz-appearance: textfield;
        }

        .factor-input::-webkit-outer-spin-button,
        .factor-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .factor-input:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2); 
            z-index: 2;
            position: relative;
        }

        .factor-input.live-cancelled {
            text-decoration: line-through;
            color: #aaa;
            border-color: transparent;
            opacity: 0.8;
            transform: scale(0.95);
        }

        .pair-color-0 { background-color: #f2f2f2; }
        .pair-color-1 { background-color: #e3f2fd; }
        .pair-color-2 { background-color: #fce4ec; }
        .pair-color-3 { background-color: #e8f5e9; }
        .pair-color-4 { background-color: #fff3e0; }

        .factor-input.correct { border-color: var(--success) !important; color: var(--success) !important; background: #fff !important; text-decoration: none; opacity: 1; transform: scale(1); }
        .factor-input.wrong { border-color: var(--danger) !important; background: #ffebeb !important; animation: shake 0.4s; }

        .big-fraction-line {
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ccc, #999, #ccc);
            border-radius: 2px;
            margin: 5px 0;
        }

        .final-answer-fraction {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            padding: 10px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }

        .final-result-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            background: linear-gradient(to right, #f8f9fa, #fff);
            padding: 15px 30px;
            border-radius: 16px;
            border: 2px solid var(--primary);
        }

        .final-input {
            width: 120px;
            height: 60px;
            font-size: 1.8rem;
            text-align: center;
            border: 2px solid #ccc;
            border-radius: 12px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .final-input:focus { border-color: var(--percent-color); outline: none; box-shadow: 0 0 0 4px rgba(157, 78, 221, 0.2); }
        .final-input.correct { border-color: var(--success); background-color: #e8f5e9; }
        .final-input.wrong { border-color: var(--danger); background-color: #ffebee; animation: shake 0.4s; }

        .answer-label { font-size: 0.9rem; color: #666; font-weight: normal; }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
            margin: 0 10px;
        }

        .btn:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(67, 97, 238, 0.4); }
        .btn:active { transform: translateY(-1px); }
        
        .btn-start { background: linear-gradient(45deg, #ff9f1c, #f39c12); display: none; }
        .btn-check { background: linear-gradient(45deg, var(--success), #20bf6b); display: none; }
        .btn-next { background: linear-gradient(45deg, var(--primary), #4834d4); display: none; }

        .feedback {
            height: 30px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .victory-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.5s;
        }

        .trophy { font-size: 100px; margin-bottom: 20px; animation: bounce 2s infinite; }
        .cert-title { font-size: 2.5rem; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-20px);} }
        
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        canvas#visualCanvas { position: relative; pointer-events: auto; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>–ú–∞—Å—Ç–µ—Ä –ü—Ä–æ—Ü–µ–Ω—Ç–æ–≤</h1>
            <div class="subtitle" id="levelDescription">–£—Ä–æ–≤–µ–Ω—å 1: –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã</div>
        </div>
        <div class="level-badges">
            <div class="lvl-badge active" id="badge1">1</div>
            <div class="lvl-badge" id="badge2">2</div>
            <div class="lvl-badge" id="badge3">3</div>
            <div class="lvl-badge" id="badge4">4</div>
            <div class="lvl-badge" id="badge5">5</div>
        </div>
        <div class="stats-box">
            –°—á—ë—Ç: <span id="score">0</span> | –û—à–∏–±–∫–∏: <span id="errors">0</span>
        </div>
    </div>

    <div class="work-area">
        
        <div class="visual-container">
            <canvas id="visualCanvas" width="600" height="80"></canvas>
        </div>

        <div class="task-statement fade-element visible" id="taskStatement"></div>
        
        <button class="btn btn-start" id="startBtn">–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É ‚úèÔ∏è</button>

        <div id="inputSection" class="fade-element" style="width: 100%; flex-direction: column; align-items: center;">
            <div class="fraction-row">
                <div class="fraction">
                    <input type="number" class="factor-input" id="percentNum">
                    <div class="frac-line"></div>
                    <div class="frac-den" id="percentDen">100</div>
                </div>
                
                <div class="operator">√ó</div>
                
                <div class="fraction">
                    <input type="number" class="factor-input" id="numberNum">
                    <div class="frac-line"></div>
                    <div class="frac-den" id="numberDen">1</div>
                </div>
                
                <div class="operator">=</div>
                
                <div class="factorization-area" id="factorArea">
                    <div class="factors-container" id="numFactorsInputs"></div>
                    <div class="big-fraction-line"></div>
                    <div class="factors-container" id="denFactorsInputs"></div>
                </div>

                <div class="operator">=</div>

                <div class="final-answer-fraction">
                    <div class="answer-box">
                        <div class="answer-label">–î—Ä–æ–±—å:</div>
                        <div class="fraction">
                            <input type="number" class="factor-input" id="finalNum">
                            <div class="frac-line"></div>
                            <input type="number" class="factor-input" id="finalDen">
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="width: 100%; border-bottom: 2px dashed #eee; margin: 20px 0;"></div>

            <div class="final-result-box">
                <div class="answer-label" style="font-size: 1.1rem; color: #333;">–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ):</div>
                <input type="number" class="final-input" id="finalResultInt" placeholder="?">
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <div class="feedback" id="feedbackMsg"></div>
        <br>
        <button class="btn btn-check" id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button class="btn btn-next" id="nextBtn">–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏–º–µ—Ä ‚û°</button>
    </div>

    <div class="victory-modal" id="victoryScreen">
        <canvas id="confettiCanvas"></canvas>
        <div class="trophy">üèÜ</div>
        <div class="cert-title">–°–ï–†–¢–ò–§–ò–ö–ê–¢ –ú–ê–°–¢–ï–†–ê</div>
        <h2>–ö—É—Ä—Å "–ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Ç —á–∏—Å–ª–∞" –ø—Ä–æ–π–¥–µ–Ω!</h2>
        <div class="cert-stats">
            <div>–í–µ—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π: <span id="finalScore" style="color:var(--success)">0</span></div>
            <div>–û—à–∏–±–æ–∫: <span id="finalErrors" style="color:var(--danger)">0</span></div>
        </div>
        <br>
        <button class="btn" onclick="location.reload()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>
</div>

<script>
const LEVELS = {
    1: { name: "–ù–æ–≤–∏—á–æ–∫", desc: "–ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã (10, 20, 25, 50)" },
    2: { name: "–£—á–µ–Ω–∏–∫", desc: "–ü—Ä–æ—Ü–µ–Ω—Ç—ã, –∫—Ä–∞—Ç–Ω—ã–µ 5" },
    3: { name: "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", desc: "–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 25 –∏ 4" },
    4: { name: "–ú–∞—Å—Ç–µ—Ä", desc: "–î–µ—Å—è—Ç–∏—á–Ω—ã–µ –¥—Ä–æ–±–∏ (–ø–æ 12.5%)" },
    5: { name: "–õ–µ–≥–µ–Ω–¥–∞", desc: "–°–ª–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏", complexReduction: true }
};

// –ë–ê–ó–ê –°–Æ–ñ–ï–¢–û–í (–õ–µ–≥–µ–Ω–¥—ã)
// {n} - —á–∏—Å–ª–æ, {p} - –ø—Ä–æ—Ü–µ–Ω—Ç
const TEMPLATES = [
    "–í –∫–ª–∞—Å—Å–µ {n} —É—á–µ–Ω–∏–∫–æ–≤. <span class='highlight-percent'>{p}%</span> –∏–∑ –Ω–∏—Ö –∑–∞–Ω–∏–º–∞—é—Ç—Å—è —Å–ø–æ—Ä—Ç–æ–º. –°–∫–æ–ª—å–∫–æ —É—á–µ–Ω–∏–∫–æ–≤ –∑–∞–Ω–∏–º–∞—é—Ç—Å—è —Å–ø–æ—Ä—Ç–æ–º?",
    "–¶–µ–Ω–∞ –∫–Ω–∏–≥–∏ {n} —Ä—É–±–ª–µ–π. –°–∫–∏–¥–∫–∞ –ø–æ –∞–∫—Ü–∏–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç <span class='highlight-percent'>{p}%</span>. –°–∫–æ–ª—å–∫–æ —Ä—É–±–ª–µ–π —Å–æ—Å—Ç–∞–≤–∏—Ç —Å–∫–∏–¥–∫–∞?",
    "–ü–∞–ø–∞ –ø–æ–ª—É—á–∏–ª –ø—Ä–µ–º–∏—é {n} —Ä—É–±–ª–µ–π. <span class='highlight-percent'>{p}%</span> –æ—Ç –ø—Ä–µ–º–∏–∏ –æ–Ω –æ—Ç–ª–æ–∂–∏–ª –Ω–∞ –æ—Ç–ø—É—Å–∫. –°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –æ–Ω –æ—Ç–ª–æ–∂–∏–ª?",
    "–í —Å–∞–¥—É —Ä–∞—Å—Ç–µ—Ç {n} –¥–µ—Ä–µ–≤—å–µ–≤. <span class='highlight-percent'>{p}%</span> –∏–∑ –Ω–∏—Ö ‚Äî —è–±–ª–æ–Ω–∏. –°–∫–æ–ª—å–∫–æ —è–±–ª–æ–Ω—å –≤ —Å–∞–¥—É?",
    "–¢–µ–ª–µ—Ñ–æ–Ω –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è. –Å–º–∫–æ—Å—Ç—å –±–∞—Ç–∞—Ä–µ–∏ {n} –º–ê—á. –°–µ–π—á–∞—Å –æ–Ω–∞ –∑–∞—Ä—è–∂–µ–Ω–∞ –Ω–∞ <span class='highlight-percent'>{p}%</span>. –°–∫–æ–ª—å–∫–æ —ç—Ç–æ –º–ê—á?",
    "–¢—ã —Å–∫–∞—á–∏–≤–∞–µ—à—å –∏–≥—Ä—É –≤–µ—Å–æ–º {n} –ì–±. –£–∂–µ —Å–∫–∞—á–∞–ª–æ—Å—å <span class='highlight-percent'>{p}%</span>. –°–∫–æ–ª—å–∫–æ –ì–± —Å–∫–∞—á–∞–ª–æ—Å—å?",
    "–ü–∏—Ü—Ü–∞ –≤–µ—Å–∏—Ç {n} –≥—Ä–∞–º–º. –¢—ã —Å—ä–µ–ª <span class='highlight-percent'>{p}%</span> –≤—Å–µ–π –ø–∏—Ü—Ü—ã. –°–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º –ø–∏—Ü—Ü—ã —Ç—ã —Å—ä–µ–ª?",
    "–ë–ª–æ–≥–µ—Ä –≤—ã–ø—É—Å—Ç–∏–ª –≤–∏–¥–µ–æ –¥–ª–∏–Ω–æ–π {n} –º–∏–Ω—É—Ç. –¢—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª <span class='highlight-percent'>{p}%</span> –≤–∏–¥–µ–æ. –°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç —Ç—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª?",
    "–í –∫–æ—Ä–æ–±–∫–µ {n} –∫–æ–Ω—Ñ–µ—Ç. <span class='highlight-percent'>{p}%</span> –∫–æ–Ω—Ñ–µ—Ç —Å —à–æ–∫–æ–ª–∞–¥–Ω–æ–π –Ω–∞—á–∏–Ω–∫–æ–π. –°–∫–æ–ª—å–∫–æ —à–æ–∫–æ–ª–∞–¥–Ω—ã—Ö –∫–æ–Ω—Ñ–µ—Ç?"
];

let state = {
    level: 1,
    tasksCompletedInLevel: 0,
    tasksToAdvance: 1, 
    score: 0,
    errors: 0,
    currentTask: null,
    animationId: null,
    timeouts: [] // –î–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
};

function clearTimeouts() {
    state.timeouts.forEach(t => clearTimeout(t));
    state.timeouts = [];
}

function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function gcd(a, b) { return b == 0 ? a : gcd(b, a % b); }

function primeFactors(n) {
    const factors = [];
    if (n === 1) return [1];
    if (n % 1 !== 0) return factors;
    let d = 2;
    let temp = n;
    while (d * d <= temp) {
        while (temp % d === 0) { factors.push(d); temp /= d; }
        d++;
    }
    if (temp > 1) factors.push(temp);
    return factors;
}

function generateTask() {
    const lvl = state.level;
    let percent, number;

    if (lvl === 1) {
        const pMap = [{p: 50, div: 2}, {p: 25, div: 4}, {p: 20, div: 5}, {p: 10, div: 10}];
        const choice = pickRandom(pMap);
        percent = choice.p;
        number = choice.div * getRandomInt(2, 20); 
    } else if (lvl === 2) {
        percent = getRandomInt(1, 19) * 5; 
        number = 20 * getRandomInt(1, 10);
    } else if (lvl === 3) {
        percent = 4 * getRandomInt(2, 24); 
        number = 25 * getRandomInt(1, 12); 
        if (number % 100 === 0 && Math.random() > 0.3) number += 25; 
    } else if (lvl === 4) {
        const decimals = [12.5, 37.5, 62.5, 87.5];
        percent = pickRandom(decimals);
        number = 8 * getRandomInt(2, 15);
    } else {
        let isValid = false;
        while (!isValid) {
            let targetResult = getRandomInt(10, 150);
            percent = 2 * getRandomInt(3, 49);
            if ((targetResult * 100) % percent === 0) {
                number = (targetResult * 100) / percent;
                if (number <= 1000 && number >= 10) isValid = true;
            }
        }
    }
    
    let result = (percent / 100) * number;
    let percentNum = percent;
    let percentDen = 100;
    
    if (percent % 1 !== 0) {
        let multiplier = 10;
        percentNum = Math.round(percent * multiplier);
        percentDen = 100 * multiplier;
    }
    
    let totalNum = percentNum * number; 
    let totalDen = percentDen;          
    
    let numFactors = primeFactors(percentNum).concat(primeFactors(number));
    numFactors.sort((a,b) => a-b);
    let denFactors = primeFactors(percentDen);
    denFactors.sort((a,b) => a-b);
    
    let finalNum = Math.round(result);
    let finalDen = 1; 
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞
    const rawTemplate = pickRandom(TEMPLATES);
    const taskText = rawTemplate
        .replace('{n}', `<span class='highlight-number'>${number}</span>`)
        .replace('{p}', percent); // percent —É–∂–µ –≤–Ω—É—Ç—Ä–∏ span –≤ —à–∞–±–ª–æ–Ω–µ

    state.currentTask = {
        text: taskText,
        percent: percent,
        number: number,
        result: result,
        percentNum: percentNum,
        percentDen: percentDen,
        numberNum: number,
        numberDen: 1,
        totalNum: totalNum,
        totalDen: totalDen,
        expectedNumFactors: numFactors,
        expectedDenFactors: denFactors,
        finalNum: finalNum,
        finalDen: finalDen
    };
    
    renderTask();
}

// –†–∏—Å—É–µ—Ç –∫–∞–¥—Ä –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
function drawFrame(currentPercent, maxPercent, number) {
    const canvas = document.getElementById('visualCanvas');
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    
    ctx.clearRect(0, 0, w, h);
    
    const padding = 20;
    const barH = 30;
    const barY = (h - barH) / 2;
    const drawW = w - padding * 2;
    
    ctx.fillStyle = '#e0e0e0';
    ctx.beginPath();
    ctx.roundRect(padding, barY, drawW, barH, 5);
    ctx.fill();
    
    let fillPct = currentPercent;
    if (fillPct > 100) fillPct = 100;
    const fillW = drawW * (fillPct / 100);
    
    if (fillW > 0) {
        ctx.fillStyle = '#9d4edd';
        ctx.beginPath();
        ctx.roundRect(padding, barY, fillW, barH, 5);
        ctx.fill();
    }
    
    ctx.fillStyle = '#333';
    ctx.font = 'bold 16px "Segoe UI"';
    ctx.textAlign = 'center';
    
    ctx.fillText("0", padding, barY + barH + 20);
    ctx.fillText(number, padding + drawW, barY + barH + 20);
    
    if (fillW > 0) {
        let xPos = padding + fillW;
        if (xPos < padding + 20) xPos = padding + 20;
        if (xPos > padding + drawW - 20) xPos = padding + drawW - 20;
        
        ctx.fillStyle = '#9d4edd';
        const label = (Math.abs(currentPercent - maxPercent) < 0.1) ? "?" : Math.round(currentPercent) + "%";
        ctx.fillText(label, xPos, barY - 10);
        
        ctx.beginPath();
        ctx.moveTo(xPos, barY - 5);
        ctx.lineTo(xPos, barY);
        ctx.strokeStyle = '#9d4edd';
        ctx.lineWidth = 2;
        ctx.stroke();
    }
}

// –£–º–Ω–∞—è –ø–µ—á–∞—Ç–Ω–∞—è –º–∞—à–∏–Ω–∫–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç HTML —Ç–µ–≥–∏ –ø—Ä–∏ –ø–∞—É–∑–∞—Ö)
function typeWriterHTML(html, elementId, speed, callback) {
    const el = document.getElementById(elementId);
    el.innerHTML = "";
    el.classList.add('typing-cursor'); // –∫—É—Ä—Å–æ—Ä –º–∏–≥–∞–µ—Ç
    
    let i = 0;
    function type() {
        if (i >= html.length) {
            el.classList.remove('typing-cursor');
            if(callback) callback();
            return;
        }
        
        const char = html.charAt(i);
        
        if (char === '<') {
            // –ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ —Ç–µ–≥, –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ –∫–æ–Ω–µ—Ü –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Ü–µ–ª–∏–∫–æ–º —Å—Ä–∞–∑—É
            let tag = '';
            while (html.charAt(i) !== '>' && i < html.length) {
                tag += html.charAt(i);
                i++;
            }
            tag += '>';
            i++;
            el.innerHTML += tag;
            // –°—Ä–∞–∑—É –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º, –Ω–µ –∂–¥–µ–º —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è —Ç–µ–≥–∞
            type();
        } else {
            el.innerHTML += char;
            i++;
            state.timeouts.push(setTimeout(type, speed));
        }
    }
    type();
}

// –ê–Ω–∏–º–∞—Ü–∏—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
function animateTaskIntro(targetPercent, targetNumber, taskText) {
    const inputsEl = document.getElementById('inputSection');
    const startBtn = document.getElementById('startBtn');
    
    // –°–±—Ä–æ—Å
    inputsEl.classList.remove('visible');
    startBtn.style.display = 'none';
    
    if (state.animationId) cancelAnimationFrame(state.animationId);
    clearTimeouts(); // —Å–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–æ–≤ —Ç–µ–∫—Å—Ç–∞
    
    // 1. –ê–Ω–∏–º–∞—Ü–∏—è —à–∫–∞–ª—ã (–û–ß–ï–ù–¨ –ú–ï–î–õ–ï–ù–ù–ê–Ø)
    let currentPct = 0;
    // –î–µ–ª–∏–º –Ω–∞ 180 (–ø—Ä–∏–º–µ—Ä–Ω–æ 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è 100%)
    const speed = Math.max(0.2, targetPercent / 180); 

    function step() {
        currentPct += speed;
        if (currentPct >= targetPercent) {
            currentPct = targetPercent;
            drawFrame(currentPct, targetPercent, targetNumber);
            
            // 2. –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—á–∞—Ç–Ω—É—é –º–∞—à–∏–Ω–∫—É —Ç–µ–∫—Å—Ç–∞
            // –°–∫–æ—Ä–æ—Å—Ç—å 30–º—Å –Ω–∞ –±—É–∫–≤—É
            typeWriterHTML(taskText, 'taskStatement', 30, () => {
                // 3. –ö–æ–≥–¥–∞ —Ç–µ–∫—Å—Ç –Ω–∞–ø–µ—á–∞—Ç–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                startBtn.style.display = 'inline-block';
            });
            
        } else {
            drawFrame(currentPct, targetPercent, targetNumber);
            state.animationId = requestAnimationFrame(step);
        }
    }
    
    step();
}

function renderTask() {
    const t = state.currentTask;
    
    document.getElementById('levelDescription').textContent = 
        `${LEVELS[state.level].name}: ${LEVELS[state.level].desc}`;
    
    for(let i = 1; i <= 5; i++) {
        const b = document.getElementById(`badge${i}`);
        b.className = 'lvl-badge';
        if(i < state.level) b.classList.add('completed');
        if(i === state.level) b.classList.add('active');
    }
    
    createInputs('numFactorsInputs', t.expectedNumFactors.length);
    createInputs('denFactorsInputs', t.expectedDenFactors.length);
    clearAllInputs();
    document.getElementById('percentDen').textContent = t.percentDen;
    
    document.getElementById('checkBtn').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'none';
    setFeedback("");
    
    // –ó–ê–ü–£–°–ö –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–ò
    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –∞–Ω–∏–º–∞—Ü–∏–µ–π
    document.getElementById('taskStatement').innerHTML = "";
    animateTaskIntro(t.percent, t.number, t.text);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å"
document.getElementById('startBtn').addEventListener('click', function() {
    this.style.display = 'none';
    const inputsEl = document.getElementById('inputSection');
    inputsEl.classList.add('visible');
    document.getElementById('checkBtn').style.display = 'inline-block';
});

function createInputs(containerId, count) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if (count === 0) {
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'factor-input';
        input.addEventListener('input', updateLiveCancellation);
        container.appendChild(input);
        return;
    }
    
    for(let i = 0; i < count; i++) {
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'factor-input';
        input.addEventListener('input', updateLiveCancellation);
        container.appendChild(input);
        
        if (i < count - 1) {
            const span = document.createElement('span');
            span.textContent = '√ó';
            span.style.color = '#777';
            span.style.fontSize = '1.5rem';
            span.style.margin = '0 5px';
            container.appendChild(span);
        }
    }
}

function clearAllInputs() {
    document.getElementById('percentNum').value = '';
    document.getElementById('numberNum').value = '';
    document.getElementById('finalNum').value = '';
    document.getElementById('finalDen').value = '';
    document.getElementById('finalResultInt').value = '';
    
    document.getElementById('percentNum').className = 'factor-input';
    document.getElementById('numberNum').className = 'factor-input';
    document.getElementById('finalNum').className = 'factor-input';
    document.getElementById('finalDen').className = 'factor-input';
    document.getElementById('finalResultInt').className = 'final-input';
    
    const factorInputs = document.querySelectorAll('.factors-container .factor-input');
    factorInputs.forEach(input => {
        input.value = '';
        input.className = 'factor-input';
        input.classList.remove('live-cancelled', 'correct', 'wrong', 
                              'pair-color-0', 'pair-color-1', 'pair-color-2', 'pair-color-3', 'pair-color-4');
    });
}

function updateLiveCancellation() {
    const nInputs = Array.from(document.querySelectorAll('#numFactorsInputs .factor-input'));
    const dInputs = Array.from(document.querySelectorAll('#denFactorsInputs .factor-input'));
    
    [...nInputs, ...dInputs].forEach(inp => {
        inp.classList.remove('live-cancelled', 'pair-color-0', 'pair-color-1', 'pair-color-2', 'pair-color-3', 'pair-color-4');
        inp.style.backgroundColor = '';
    });
    
    let colorIndex = 0;
    const dTakenIndices = new Set();
    
    nInputs.forEach((nInp, nIndex) => {
        const nVal = parseInt(nInp.value);
        if (isNaN(nVal) || nVal === 1) return;
        
        for (let dIndex = 0; dIndex < dInputs.length; dIndex++) {
            if (dTakenIndices.has(dIndex)) continue;
            
            const dVal = parseInt(dInputs[dIndex].value);
            if (nVal === dVal) {
                dTakenIndices.add(dIndex);
                const colorClass = `pair-color-${colorIndex % 5}`;
                nInp.classList.add('live-cancelled', colorClass);
                dInputs[dIndex].classList.add('live-cancelled', colorClass);
                colorIndex++;
                break;
            }
        }
    });
}

document.getElementById('checkBtn').addEventListener('click', checkAnswer);
document.getElementById('nextBtn').addEventListener('click', nextTask);

function checkAnswer() {
    const t = state.currentTask;
    let allCorrect = true;
    
    const userPercentNum = parseFloat(document.getElementById('percentNum').value);
    const percentNumEl = document.getElementById('percentNum');
    if (userPercentNum === t.percentNum) percentNumEl.classList.add('correct');
    else { percentNumEl.classList.add('wrong'); allCorrect = false; }
    
    const userNumberNum = parseFloat(document.getElementById('numberNum').value);
    const numberNumEl = document.getElementById('numberNum');
    if (userNumberNum === t.numberNum) numberNumEl.classList.add('correct');
    else { numberNumEl.classList.add('wrong'); allCorrect = false; }
    
    const userNumInputs = document.querySelectorAll('#numFactorsInputs .factor-input');
    const userNumVals = Array.from(userNumInputs).map(i => parseFloat(i.value) || 1).sort((a,b)=>a-b);
    const userDenInputs = document.querySelectorAll('#denFactorsInputs .factor-input');
    const userDenVals = Array.from(userDenInputs).map(i => parseFloat(i.value) || 1).sort((a,b)=>a-b);
    
    if (JSON.stringify(userNumVals) === JSON.stringify(t.expectedNumFactors) &&
        JSON.stringify(userDenVals) === JSON.stringify(t.expectedDenFactors)) {
        userNumInputs.forEach(i => i.classList.add('correct'));
        userDenInputs.forEach(i => i.classList.add('correct'));
    } else {
        userNumInputs.forEach(i => i.classList.add('wrong'));
        userDenInputs.forEach(i => i.classList.add('wrong'));
        allCorrect = false;
    }
    
    const uFinalNum = parseFloat(document.getElementById('finalNum').value);
    const uFinalDen = parseFloat(document.getElementById('finalDen').value) || 1;
    const finalNumEl = document.getElementById('finalNum');
    const finalDenEl = document.getElementById('finalDen');
    
    if (uFinalNum === t.finalNum && uFinalDen === t.finalDen) {
        finalNumEl.classList.add('correct');
        finalDenEl.classList.add('correct');
    } else {
        finalNumEl.classList.add('wrong');
        finalDenEl.classList.add('wrong');
        allCorrect = false;
    }
    
    const finalIntEl = document.getElementById('finalResultInt');
    const userFinalInt = parseInt(finalIntEl.value);
    const correctFinalInt = Math.round(t.result);
    
    if (userFinalInt === correctFinalInt) {
        finalIntEl.classList.add('correct');
    } else {
        finalIntEl.classList.add('wrong');
        allCorrect = false;
    }

    if (allCorrect) {
        setFeedback("–í–µ—Ä–Ω–æ! üåü", "success");
        state.score++;
        state.tasksCompletedInLevel++;
        document.getElementById('score').textContent = state.score;
        document.getElementById('checkBtn').style.display = 'none';
        
        if (state.tasksCompletedInLevel >= state.tasksToAdvance) {
            document.getElementById('nextBtn').textContent = state.level < 5 ? "–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å! üÜô" : "–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç! üèÜ";
        } else {
            document.getElementById('nextBtn').textContent = "–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏–º–µ—Ä ‚û°";
        }
        document.getElementById('nextBtn').style.display = 'inline-block';
    } else {
        if (userFinalInt !== correctFinalInt && !isNaN(userFinalInt)) {
            setFeedback("–û—à–∏–±–∫–∞ –≤ –∏—Ç–æ–≥–æ–≤–æ–º –æ—Ç–≤–µ—Ç–µ.", "error");
        } else {
            setFeedback("–ï—Å—Ç—å –æ—à–∏–±–∫–∏. –ü—Ä–æ–≤–µ—Ä—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.", "error");
        }
        state.errors++;
        document.getElementById('errors').textContent = state.errors;
    }
}

function nextTask() {
    const factorInputs = document.querySelectorAll('.factors-container .factor-input');
    factorInputs.forEach(input => input.removeEventListener('input', updateLiveCancellation));
    
    if (state.tasksCompletedInLevel >= state.tasksToAdvance) {
        if (state.level === 5) { showVictory(); return; }
        state.level++;
        state.tasksCompletedInLevel = 0;
    }
    generateTask();
}

function setFeedback(msg, type) {
    const el = document.getElementById('feedbackMsg');
    el.textContent = msg;
    el.style.opacity = 1;
    el.style.color = type === 'error' ? '#e71d36' : '#2ec4b6';
}

function showVictory() {
    document.getElementById('victoryScreen').style.display = 'flex';
    document.getElementById('finalScore').textContent = state.score;
    document.getElementById('finalErrors').textContent = state.errors;
    startConfetti();
}

function startConfetti() {
    const canvas = document.getElementById('confettiCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const pieces = [];
    const colors = ['#4361ee', '#9d4edd', '#2ec4b6', '#ff9f1c', '#e71d36', '#fbc2eb'];
    for(let i=0; i<300; i++) {
        pieces.push({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height-canvas.height,
            color: colors[Math.floor(Math.random()*colors.length)],
            size: Math.random()*10+5, speed: Math.random()*5+2,
            angle: Math.random()*Math.PI*2, spin: Math.random()*0.2-0.1
        });
    }
    function animate() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        pieces.forEach(p => {
            p.y+=p.speed; p.angle+=p.spin; p.x+=Math.sin(p.angle)*2;
            if(p.y>canvas.height) p.y=-20;
            ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.angle);
            ctx.fillStyle=p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.restore();
        });
        requestAnimationFrame(animate);
    }
    animate();
}

generateTask();
</script>
</body>
</html>